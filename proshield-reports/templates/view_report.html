{% extends "base.html" %}

{% block title %}×“×•×— #{{ report.id }} - Proshield Reports{% endblock %}

{% block content %}
<div class="view-report-page">
    <div class="page-header">
        <a href="{{ url_for('dashboard') }}" class="back-link">â—€ ×—×–×¨×” ×œ×“×•×—×•×ª</a>
        <h1>ğŸ“‹ ×“×•×— #{{ report.id }}</h1>
        <div class="report-actions">
            <button class="btn btn-danger btn-sm" id="deleteBtn" title="××—×§ ×“×•×—">
                ğŸ—‘ï¸ ××—×§
            </button>
        </div>
    </div>

    <div class="report-details">
        <!-- Report Info Card -->
        <div class="detail-card">
            <div class="detail-header">
                <span class="report-type {{ report.report_type }}">
                    {% if report.report_type == 'delivery' %}
                    ğŸšš ××¡×¤×§×”
                    {% else %}
                    ğŸ”§ ×”×ª×§× ×”
                    {% endif %}
                </span>
                <span class="report-status {{ report.status }}">
                    {% if report.status == 'completed' %}
                    âœ… ×”×•×©×œ×
                    {% else %}
                    ğŸ”„ × ×“×¨×© ×—×–×¨×”
                    {% endif %}
                </span>
            </div>

            <div class="detail-row">
                <span class="detail-label">ğŸ‘¤ ××©×ª××©:</span>
                <span class="detail-value">{{ report.author.full_name }}</span>
            </div>

            <div class="detail-row">
                <span class="detail-label">ğŸ“ {% if report.report_type == 'delivery' %}×›×ª×•×‘×ª ××¡×¤×§×”{% else %}×›×ª×•×‘×ª ×”×ª×§× ×”{% endif %}:</span>
                <span class="detail-value">{{ report.address }}</span>
            </div>

            {% if report.report_type == 'installation' %}
            <div class="detail-row">
                <span class="detail-label">ğŸ§© ×¡×•×’ ×”×ª×§× ×”:</span>
                <span class="detail-value">{{ report.installation_type or '-' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">ğŸ”¢ ××¡×¤×¨ ×”×’× ×•×ª:</span>
                <span class="detail-value">{{ report.protections_count or '-' }}</span>
            </div>
            {% endif %}

            <div class="detail-row">
                <span class="detail-label">ğŸ“… ×ª××¨×™×š:</span>
                <span class="detail-value">{{ report.timestamp.strftime('%d/%m/%Y %H:%M') }}</span>
            </div>

            {% if report.notes %}
            <div class="detail-row">
                <span class="detail-label">ğŸ“ ×”×¢×¨×•×ª:</span>
                <span class="detail-value">{{ report.notes }}</span>
            </div>
            {% endif %}
        </div>

        <!-- Products Card -->
        <div class="detail-card">
            <h2>ğŸ“¦ ××•×¦×¨×™×</h2>
            <div class="products-table">
                <table>
                    <thead>
                        <tr>
                            <th>××•×¦×¨</th>
                            <th>{% if report.report_type == 'delivery' %}×›××•×ª ×©×¡×•×¤×§×”{% else %}×›××•×ª ×©×”×•×ª×§× ×”{% endif %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in report.products %}
                        <tr>
                            <td>{{ product.product_name }}</td>
                            <td>{{ product.quantity }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Images Card -->
        {% if report.images.count() > 0 %}
        <div class="detail-card">
            <h2>ğŸ“· {% if report.report_type == 'delivery' %}×ª××•× ×•×ª ×¡×—×•×¨×”{% else %}×ª××•× ×•×ª ×”×¤×¨×•×™×§×˜{% endif %}</h2>
            <div class="images-gallery">
                {% for image in report.images %}
                <div class="gallery-item">
                    <img src="/uploads/reports/{{ image.image_path }}"
                         alt="×ª××•× ×” {{ loop.index }}"
                         onclick="openLightbox(this.src)">
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Delivery Note Card (for delivery reports only) -->
        {% if report.report_type == 'delivery' and report.documents.count() > 0 %}
        <div class="detail-card delivery-note-card">
            <h2>ğŸ“„ ×ª×¢×•×“×ª ××©×œ×•×— ×—×ª×•××”</h2>
            <div class="delivery-note-display">
                {% for doc in report.documents %}
                {% set is_image = doc.document_path.lower().endswith(('.jpg', '.jpeg', '.png')) %}
                {% set is_pdf = doc.document_path.lower().endswith('.pdf') %}
                <div class="delivery-note-item">
                    {% if is_image %}
                    <!-- Image thumbnail with click to enlarge -->
                    <div class="delivery-note-thumbnail" onclick="openLightbox('/uploads/reports/{{ doc.document_path }}')">
                        <img src="/uploads/reports/{{ doc.document_path }}" alt="×ª×¢×•×“×ª ××©×œ×•×—">
                        <div class="thumbnail-overlay">
                            <span>ğŸ” ×œ×—×¥ ×œ×”×’×“×œ×”</span>
                        </div>
                    </div>
                    {% else %}
                    <!-- PDF icon -->
                    <div class="delivery-note-pdf">
                        <span class="pdf-icon">ğŸ“„</span>
                        <span class="pdf-label">PDF</span>
                    </div>
                    {% endif %}
                    <div class="delivery-note-info">
                        <span class="doc-name">{{ doc.original_filename or '×ª×¢×•×“×ª ××©×œ×•×— ×—×ª×•××”' }}</span>
                        <div class="delivery-note-actions">
                            <a href="/uploads/reports/{{ doc.document_path }}" target="_blank" class="btn btn-sm btn-secondary">
                                ğŸ‘ï¸ ×¦×¤×”
                            </a>
                            <a href="/uploads/reports/{{ doc.document_path }}" download class="btn btn-sm btn-primary">
                                â¬‡ï¸ ×”×•×¨×“
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
    <span class="lightbox-close">&times;</span>
    <img src="" alt="Enlarged image" id="lightboxImg">
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <h3>ğŸ—‘ï¸ ××—×™×§×ª ×“×•×—</h3>
        <p>×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×“×•×—?</p>
        <p class="warning">×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!</p>
        <div class="modal-actions">
            <button class="btn btn-ghost" id="cancelDelete">×‘×™×˜×•×œ</button>
            <button class="btn btn-danger" id="confirmDelete">××—×§</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const reportId = {{ report.id }};

    // Lightbox functions
    function openLightbox(src) {
        document.getElementById('lightboxImg').src = src;
        document.getElementById('lightbox').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
        document.getElementById('lightbox').classList.remove('active');
        document.body.style.overflow = '';
    }

    // Close lightbox on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeLightbox();
        }
    });

    // Delete functionality
    const deleteBtn = document.getElementById('deleteBtn');
    const deleteModal = document.getElementById('deleteModal');
    const cancelDelete = document.getElementById('cancelDelete');
    const confirmDelete = document.getElementById('confirmDelete');

    deleteBtn.addEventListener('click', () => {
        deleteModal.classList.add('active');
    });

    cancelDelete.addEventListener('click', () => {
        deleteModal.classList.remove('active');
    });

    deleteModal.addEventListener('click', (e) => {
        if (e.target === deleteModal) {
            deleteModal.classList.remove('active');
        }
    });

    confirmDelete.addEventListener('click', async () => {
        confirmDelete.disabled = true;
        confirmDelete.textContent = '××•×—×§...';

        try {
            const response = await fetch(`/api/reports/${reportId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                showToast('×”×“×•×— × ××—×§ ×‘×”×¦×œ×—×”', 'success');
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 1500);
            } else {
                showToast(data.error || '×©×’×™××” ×‘××—×™×§×ª ×”×“×•×—', 'error');
                deleteModal.classList.remove('active');
            }
        } catch (error) {
            showToast('×©×’×™××ª ×ª×§×©×•×¨×ª', 'error');
            deleteModal.classList.remove('active');
        } finally {
            confirmDelete.disabled = false;
            confirmDelete.textContent = '××—×§';
        }
    });
</script>
{% endblock %}
