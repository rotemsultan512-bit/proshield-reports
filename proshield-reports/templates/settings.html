{% extends "base.html" %}

{% block title %}×”×’×“×¨×•×ª - Proshield Reports{% endblock %}

{% block content %}
<div class="settings-page">
    <div class="page-header">
        <h1>âš™ï¸ ×”×’×“×¨×•×ª</h1>
    </div>

    <div class="settings-container">
        <!-- User Info Card -->
        <div class="settings-card">
            <h2>ğŸ‘¤ ×¤×¨×˜×™ ××©×ª××©</h2>
            <div class="user-info">
                <div class="info-row">
                    <span class="info-label">×©× ××©×ª××©:</span>
                    <span class="info-value">{{ current_user.username }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">×©× ××œ×:</span>
                    <span class="info-value">{{ current_user.full_name }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">×ª×¤×§×™×“:</span>
                    <span class="info-value">{{ '×× ×”×œ' if current_user.is_admin() else '××©×ª××©' }}</span>
                </div>
            </div>
        </div>

        <!-- Change Password Card -->
        <div class="settings-card">
            <h2>ğŸ” ×©×™× ×•×™ ×¡×™×¡××”</h2>
            <form id="passwordForm" class="password-form">
                <div class="form-group">
                    <label for="currentPassword">×¡×™×¡××” × ×•×›×—×™×ª</label>
                    <input type="password" id="currentPassword" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">×¡×™×¡××” ×—×“×©×”</label>
                    <input type="password" id="newPassword" minlength="6" required>
                    <small>×œ×¤×—×•×ª 6 ×ª×•×•×™×</small>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">××™××•×ª ×¡×™×¡××” ×—×“×©×”</label>
                    <input type="password" id="confirmPassword" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    ğŸ’¾ ×©××•×¨ ×¡×™×¡××”
                </button>
            </form>
        </div>

        <!-- App Info Card -->
        <div class="settings-card">
            <h2>â„¹ï¸ ××•×“×•×ª ×”××¤×œ×™×§×¦×™×”</h2>
            <div class="app-info">
                <div class="info-row">
                    <span class="info-label">×’×¨×¡×”:</span>
                    <span class="info-value">1.0.0</span>
                </div>
                <div class="info-row">
                    <span class="info-label">×¡×˜×˜×•×¡ PWA:</span>
                    <span class="info-value" id="pwaStatus">×‘×•×“×§...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">×“×•×—×•×ª ××§×•××™×™×:</span>
                    <span class="info-value" id="offlineCount">0</span>
                </div>
            </div>

            <!-- Install PWA Button -->
            <button class="btn btn-secondary btn-block" id="installPwaBtn" style="display:none;">
                ğŸ“² ×”×ª×§×Ÿ ××¤×œ×™×§×¦×™×”
            </button>

            <!-- Clear Local Data -->
            <button class="btn btn-ghost btn-block" id="clearLocalBtn">
                ğŸ—‘ï¸ × ×§×” × ×ª×•× ×™× ××§×•××™×™×
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Password change form
    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            showToast('×”×¡×™×¡×××•×ª ××™× ×Ÿ ×ª×•×××•×ª', 'error');
            return;
        }

        if (newPassword.length < 6) {
            showToast('×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 6 ×ª×•×•×™×', 'error');
            return;
        }

        try {
            const response = await fetch('/api/user/password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            });

            const data = await response.json();

            if (data.success) {
                showToast('×”×¡×™×¡××” ×©×•× ×ª×” ×‘×”×¦×œ×—×”', 'success');
                document.getElementById('passwordForm').reset();
            } else {
                showToast(data.error || '×©×’×™××” ×‘×©×™× ×•×™ ×”×¡×™×¡××”', 'error');
            }
        } catch (error) {
            showToast('×©×’×™××ª ×ª×§×©×•×¨×ª', 'error');
        }
    });

    // PWA status check
    function checkPwaStatus() {
        const pwaStatus = document.getElementById('pwaStatus');

        if (window.matchMedia('(display-mode: standalone)').matches) {
            pwaStatus.textContent = '××•×ª×§×Ÿ âœ…';
        } else if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistration().then(reg => {
                pwaStatus.textContent = reg ? '×–××™×Ÿ ×œ×”×ª×§× ×”' : '×œ× × ×ª××š';
            });
        } else {
            pwaStatus.textContent = '×œ× × ×ª××š';
        }
    }

    // Check offline reports count
    function updateOfflineCount() {
        const offlineReports = JSON.parse(localStorage.getItem('offlineReports') || '[]');
        document.getElementById('offlineCount').textContent = offlineReports.length;
    }

    // Install PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installPwaBtn').style.display = 'block';
    });

    document.getElementById('installPwaBtn').addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                showToast('×”××¤×œ×™×§×¦×™×” ×”×•×ª×§× ×” ×‘×”×¦×œ×—×”', 'success');
            }
            deferredPrompt = null;
            document.getElementById('installPwaBtn').style.display = 'none';
        }
    });

    // Clear local data
    document.getElementById('clearLocalBtn').addEventListener('click', () => {
        if (confirm('×”×× ××ª×” ×‘×˜×•×—? ×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”×“×•×—×•×ª ×”××§×•××™×™× ×©×œ× ×¡×•× ×›×¨× ×•.')) {
            localStorage.removeItem('offlineReports');
            showToast('×”× ×ª×•× ×™× ×”××§×•××™×™× × ××—×§×•', 'success');
            updateOfflineCount();
        }
    });

    // Initialize
    checkPwaStatus();
    updateOfflineCount();
</script>
{% endblock %}
