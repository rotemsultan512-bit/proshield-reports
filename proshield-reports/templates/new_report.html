{% extends "base.html" %}

{% block title %}×“×•×— ×—×“×© - Proshield Reports{% endblock %}

{% block content %}
<div class="new-report-page">
    <div class="page-header">
        <a href="{{ url_for('dashboard') }}" class="back-link">â—€ ×—×–×¨×” ×œ×“×•×—×•×ª</a>
        <h1>ğŸ“ ×“×•×— ×—×“×©</h1>
    </div>

    <form id="reportForm" class="report-form">
        <!-- Step 1: Report Type -->
        <div class="form-section">
            <h2>1. ×¡×•×’ ×“×•×—</h2>
            <div class="report-type-selector">
                <label class="type-option">
                    <input type="radio" name="report_type" value="delivery" required>
                    <div class="type-card">
                        <span class="type-icon">ğŸšš</span>
                        <span class="type-label">××¡×¤×§×”</span>
                    </div>
                </label>
                <label class="type-option">
                    <input type="radio" name="report_type" value="installation" required>
                    <div class="type-card">
                        <span class="type-icon">ğŸ”§</span>
                        <span class="type-label">×”×ª×§× ×”</span>
                    </div>
                </label>
            </div>


        </div>

        <!-- Step 2: Address + Customer + Date/Time -->
        <div class="form-section">
            <h2>2. <span id="addressLabel">×›×ª×•×‘×ª</span></h2>
            <div class="form-group">
                <input type="text" id="address" name="address" placeholder="×”×–×Ÿ ×›×ª×•×‘×ª..." required>
            </div>

            <div class="form-group" id="customerNameWrap" style="display:none;">
                <label for="customer_name">×©× ×œ×§×•×— <span class="required-badge">×—×•×‘×”</span></label>
                <input type="text" id="customer_name" name="customer_name" placeholder="×”×–×Ÿ ×©× ×œ×§×•×—...">
            </div>

            <div class="form-group" id="companyProjectWrap" style="display:none;">
                <label for="company_project">×—×‘×¨×ª ×‘× ×™×”/×¤×¨×•×™×§×˜ <span class="optional-badge">××•×¤×¦×™×•× ×œ×™</span></label>
                <input type="text" id="company_project" name="company_project" list="companyProjectOptions" placeholder="×‘×—×¨ ××• ×”×§×œ×“...">
                <datalist id="companyProjectOptions"></datalist>
            </div>

            <div class="form-group" id="reportDateWrap" style="display:none;">
                <label for="report_datetime">×ª××¨×™×š ×•×©×¢×” <span class="required-badge">×—×•×‘×”</span></label>
                <input type="datetime-local" id="report_datetime" name="report_datetime">
            </div>

            <div class="installation-details" id="installationDetails" style="display:none;">
                <h3>×¡×•×’ ×”×ª×§× ×”</h3>

                <div class="form-group">
                    <label>×‘×—×¨ ×¡×•×’/×™× ×©×œ ×”×ª×§× ×”</label>
                    <div class="installation-types" id="installationTypesWrap">
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="×”×’× ×ª ××“×¨×’×•×ª">
                            <span>×”×’× ×ª ××“×¨×’×•×ª</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="×”×’× ×ª ×¤×¨×§×˜">
                            <span>×”×’× ×ª ×¤×¨×§×˜</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="×”×’× ×ª ×¨×™×¦×•×£">
                            <span>×”×’× ×ª ×¨×™×¦×•×£</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="×”×’× ×ª ××˜×‘×—">
                            <span>×”×’× ×ª ××˜×‘×—</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="×”×’× ×ª ×—×œ×•× ×•×ª">
                            <span>×”×’× ×ª ×—×œ×•× ×•×ª</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="×”×’× ×” ×œ×“×œ×ª ×›× ×™×¡×”">
                            <span>×”×’× ×” ×œ×“×œ×ª ×›× ×™×¡×”</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="×”×’× ×” ×œ×“×œ×ª ×¤× ×™×">
                            <span>×”×’× ×” ×œ×“×œ×ª ×¤× ×™×</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="×”×’× ×” ×œ×¨×™×¦×•×£ ×—×•×¥">
                            <span>×”×’× ×” ×œ×¨×™×¦×•×£ ×—×•×¥</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="×”×’× ×” ×œ× ×’×¨×•×™×•×ª">
                            <span>×”×’× ×” ×œ× ×’×¨×•×™×•×ª</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="×”×’× ×ª ××¢×œ×™×ª">
                            <span>×”×’× ×ª ××¢×œ×™×ª</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="×”×’× ×ª ×¤×¨×•×¤×™×œ×™ ×—×œ×•×Ÿ">
                            <span>×”×’× ×ª ×¤×¨×•×¤×™×œ×™ ×—×œ×•×Ÿ</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="×”×’× ×ª ××¢×§×•×ª">
                            <span>×”×’× ×ª ××¢×§×•×ª</span>
                        </label>
                    </div>
                    <small>× ×™×ª×Ÿ ×œ×‘×—×•×¨ ×™×•×ª×¨ ××¡×•×’ ××—×“</small>
                </div>
            </div>
        </div>

        <!-- Step 3: Products -->
        <div class="form-section">
            <h2>3. ××•×¦×¨×™×</h2>
            <div class="products-selector">
                <div class="products-search">
                    <input type="text" id="productSearch" placeholder="ğŸ” ×—×¤×© ××•×¦×¨...">
                </div>
                <div class="products-list" id="productsList">
                    {% for product in products %}
                    <label class="product-item">
                        <input type="checkbox" name="products" value="{{ product }}">
                        <span class="product-name">{{ product }}</span>
                        <div class="product-quantity" style="display:none;">
                            <label id="quantityLabel">×›××•×ª:</label>
                            <div class="quantity-row">
                                <input type="number" step="0.1" min="0" placeholder="0" class="quantity-input">
                                <select class="quantity-unit">
                                    <option value="unit">×™×—×™×“×”</option>
                                    <option value="meter">××˜×¨</option>
                                </select>
                            </div>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>
            <div class="selected-products" id="selectedProducts">
                <h3>××•×¦×¨×™× ×©× ×‘×—×¨×•:</h3>
                <div class="selected-list" id="selectedList">
                    <p class="no-selection">×œ× × ×‘×—×¨×• ××•×¦×¨×™×</p>
                </div>
            </div>
        </div>

        <!-- Step 4: Status -->
        <div class="form-section">
            <h2>4. ×¡×˜×˜×•×¡</h2>
            <div class="status-selector">
                <label class="status-option">
                    <input type="radio" name="status" value="completed" required>
                    <div class="status-card completed">
                        <span class="status-icon">âœ…</span>
                        <span class="status-label">×”×•×©×œ×</span>
                    </div>
                </label>
                <label class="status-option">
                    <input type="radio" name="status" value="return_required" required>
                    <div class="status-card return">
                        <span class="status-icon">ğŸ”„</span>
                        <span class="status-label">× ×“×¨×© ×—×–×¨×”</span>
                    </div>
                </label>
            </div>
        </div>

        <!-- Step 5: Photos -->
        <div class="form-section">
            <h2>5. <span id="photosLabel">×ª××•× ×•×ª</span></h2>
            <div class="photos-upload">
                <div class="upload-area" id="photosUploadArea">
                    <input type="file" id="photosInput" name="images" accept="image/*" multiple style="display:none;">
                    <input type="file" id="photosCameraInput" accept="image/*" capture="environment" multiple style="display:none;">
                    <div class="upload-placeholder">
                        <span class="upload-icon">ğŸ“·</span>
                        <span class="upload-text">×¦×™×œ×•× ××• ×”×¢×œ××ª ×ª××•× ×•×ª</span>
                        <div class="upload-actions">
                            <button type="button" class="btn btn-secondary btn-sm" id="photosCameraBtn">×¦×œ× ×ª××•× ×”</button>
                            <button type="button" class="btn btn-primary btn-sm" id="photosUploadBtn">×”×¢×œ×” ×ª××•× ×•×ª</button>
                        </div>
                        <span class="upload-hint">×¢×“ 10 ×ª××•× ×•×ª, 5MB ×›×œ ××—×ª</span>
                    </div>
                </div>
                <div class="photos-preview" id="photosPreview"></div>
            </div>
        </div>

        <!-- Step 6: Delivery Note (Delivery Only - MANDATORY) -->
        <div class="form-section delivery-note-section" id="deliveryNoteSection" style="display:none;">
            <h2>6. ×ª×¢×•×“×ª ××©×œ×•×— ×—×ª×•××” <span class="required-badge">×—×•×‘×”</span></h2>
            <div class="delivery-note-upload">
                <div class="upload-area" id="deliveryNoteUploadArea">
                    <input type="file" id="deliveryNoteInput" name="delivery_note" accept=".pdf,.jpg,.jpeg,.png,image/*" style="display:none;">
                    <input type="file" id="deliveryNoteCameraInput" accept="image/*" capture="environment" style="display:none;">
                    <div class="upload-placeholder">
                        <span class="upload-icon">ğŸ“„</span>
                        <span class="upload-text">×¦×™×œ×•× ××• ×”×¢×œ××ª ×ª×¢×•×“×ª ××©×œ×•×— ×—×ª×•××”</span>
                        <div class="upload-actions">
                            <button type="button" class="btn btn-secondary btn-sm" id="deliveryNoteCameraBtn">×¦×œ× ××¡××š</button>
                            <button type="button" class="btn btn-primary btn-sm" id="deliveryNoteUploadBtn">×”×¢×œ×” ×§×•×‘×¥</button>
                        </div>
                        <span class="upload-hint">PDF ××• ×ª××•× ×” (jpg, png), ×¢×“ 10MB</span>
                    </div>
                </div>
                <div class="delivery-note-preview" id="deliveryNotePreview"></div>
                <div class="delivery-note-error" id="deliveryNoteError" style="display:none;">
                    <span class="error-icon">âš ï¸</span>
                    <span class="error-text">×™×© ×œ×”×¢×œ×•×ª ×ª×¢×•×“×ª ××©×œ×•×— ×—×ª×•××”</span>
                </div>
            </div>
        </div>

        <!-- Step 7: Notes -->
        <div class="form-section">
            <h2 id="notesStepLabel">6. ×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)</h2>
            <div class="form-group">
                <textarea id="notes" name="notes" rows="3" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª..."></textarea>
            </div>
        </div>

        <!-- Submit -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg btn-block" id="submitBtn">
                <span class="btn-text">ğŸ’¾ ×©××•×¨ ×“×•×—</span>
                <span class="btn-loading" style="display:none;">
                    <span class="spinner"></span>
                    ×©×•××¨...
                </span>
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // DOM Elements
    const reportForm = document.getElementById('reportForm');
    const reportTypeInputs = document.querySelectorAll('input[name="report_type"]');
    const addressLabel = document.getElementById('addressLabel');
    const photosLabel = document.getElementById('photosLabel');
    const documentSection = document.getElementById('documentSection');
    const notesStepLabel = document.getElementById('notesStepLabel');
    const productSearch = document.getElementById('productSearch');
    const productItems = document.querySelectorAll('.product-item');
    const photosInput = document.getElementById('photosInput');
    const photosCameraInput = document.getElementById('photosCameraInput');
    const photosUploadArea = document.getElementById('photosUploadArea');
    const photosUploadBtn = document.getElementById('photosUploadBtn');
    const photosCameraBtn = document.getElementById('photosCameraBtn');
    const photosPreview = document.getElementById('photosPreview');
    const deliveryNoteInput = document.getElementById('deliveryNoteInput');
    const deliveryNoteCameraInput = document.getElementById('deliveryNoteCameraInput');
    const deliveryNoteUploadArea = document.getElementById('deliveryNoteUploadArea');
    const deliveryNoteUploadBtn = document.getElementById('deliveryNoteUploadBtn');
    const deliveryNoteCameraBtn = document.getElementById('deliveryNoteCameraBtn');
    const deliveryNotePreview = document.getElementById('deliveryNotePreview');
    const deliveryNoteSection = document.getElementById('deliveryNoteSection');
    const deliveryNoteError = document.getElementById('deliveryNoteError');
    const submitBtn = document.getElementById('submitBtn');

    // Installation details
    const installationDetails = document.getElementById('installationDetails');
    const installationTypesWrap = document.getElementById('installationTypesWrap');

    // Delivery / Installation extra fields
    const customerNameWrap = document.getElementById('customerNameWrap');
    const customerNameInput = document.getElementById('customer_name');
    const companyProjectWrap = document.getElementById('companyProjectWrap');
    const companyProjectInput = document.getElementById('company_project');
    const companyProjectOptions = document.getElementById('companyProjectOptions');
    const reportDateWrap = document.getElementById('reportDateWrap');
    const reportDateInput = document.getElementById('report_datetime');

    // Selected products data
    let selectedProducts = [];
    let uploadedPhotos = [];
    let uploadedDeliveryNote = null;

    loadCompanyProjects();

    function resetInstallationFields() {
        if (installationTypesWrap) {
            installationTypesWrap.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }
    }

    function setDefaultReportDateTime() {
        if (!reportDateInput) return;
        if (reportDateInput.value) return;

        const now = new Date();
        const pad = (n) => String(n).padStart(2, '0');
        const localValue = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
        reportDateInput.value = localValue;
    }

    async function loadCompanyProjects() {
        if (!companyProjectOptions) return;

        try {
            const response = await fetch('/api/company-projects');
            const data = await response.json();
            const projects = data.projects || [];

            companyProjectOptions.innerHTML = projects.map(p => `
                <option value="${escapeHtml(p.name)}"></option>
            `).join('');
        } catch (error) {
            console.error('Error loading company/project list:', error);
        }
    }

    function getSelectedInstallationTypes() {
        return Array.from(document.querySelectorAll('input[name="installation_types"]:checked'))
            .map(cb => cb.value);
    }

    // Report type change handler
    reportTypeInputs.forEach(input => {
        input.addEventListener('change', (e) => {
            const type = e.target.value;

            if (type === 'delivery') {
                addressLabel.textContent = '×›×ª×•×‘×ª ××¡×¤×§×”';
                photosLabel.textContent = '×ª××•× ×•×ª ×¡×—×•×¨×” ×©×¡×•×¤×§×”';
                deliveryNoteSection.style.display = 'block';
                notesStepLabel.textContent = '7. ×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)';
                updateQuantityLabels('×›××•×ª ×©×¡×•×¤×§×”:');

                // Customer + Date/Time are mandatory
                customerNameWrap.style.display = 'block';
                customerNameInput.required = true;
                companyProjectWrap.style.display = 'block';
                reportDateWrap.style.display = 'block';
                reportDateInput.required = true;
                setDefaultReportDateTime();

                // Hide installation details
                installationDetails.style.display = 'none';
                resetInstallationFields();
            } else {
                addressLabel.textContent = '×›×ª×•×‘×ª ×”×ª×§× ×”';
                photosLabel.textContent = '×ª××•× ×•×ª ×”×¤×¨×•×™×§×˜';
                deliveryNoteSection.style.display = 'none';
                notesStepLabel.textContent = '6. ×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™)';
                updateQuantityLabels('×›××•×ª ×©×”×•×ª×§× ×”:');

                // Installation: show customer + date
                customerNameWrap.style.display = 'block';
                customerNameInput.required = true;
                companyProjectWrap.style.display = 'block';
                reportDateWrap.style.display = 'block';
                reportDateInput.required = true;
                setDefaultReportDateTime();

                // Clear delivery note error when switching to installation
                deliveryNoteError.style.display = 'none';

                // Show installation details before products
                installationDetails.style.display = 'block';
                resetInstallationFields();
            }
        });
    });



    function updateQuantityLabels(text) {
        document.querySelectorAll('.product-quantity label').forEach(label => {
            label.textContent = text;
        });
    }

    // Product search
    productSearch.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        productItems.forEach(item => {
            const productName = item.querySelector('.product-name').textContent.toLowerCase();
            item.style.display = productName.includes(searchTerm) ? 'flex' : 'none';
        });
    });

    // Product selection
    productItems.forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        const quantityDiv = item.querySelector('.product-quantity');
        const quantityInput = item.querySelector('.quantity-input');

        checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
                quantityDiv.style.display = 'flex';
                quantityInput.focus();
            } else {
                quantityDiv.style.display = 'none';
                quantityInput.value = '';
            }
            updateSelectedProducts();
        });

        quantityInput.addEventListener('input', updateSelectedProducts);
    });

    function updateSelectedProducts() {
        selectedProducts = [];
        const selectedList = document.getElementById('selectedList');

        productItems.forEach(item => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            const quantityInput = item.querySelector('.quantity-input');

            if (checkbox.checked && quantityInput.value) {
                const unitSelect = item.querySelector('.quantity-unit');
                selectedProducts.push({
                    name: checkbox.value,
                    quantity: parseFloat(quantityInput.value) || 0,
                    unit: unitSelect ? unitSelect.value : 'unit'
                });
            }
        });

        if (selectedProducts.length === 0) {
            selectedList.innerHTML = '<p class="no-selection">×œ× × ×‘×—×¨×• ××•×¦×¨×™×</p>';
        } else {
            selectedList.innerHTML = selectedProducts.map(p => `
                <div class="selected-item">
                    <span class="item-name">${escapeHtml(p.name)}</span>
                    <span class="item-qty">${p.quantity} ${p.unit === 'meter' ? '××³' : '×™×—×³'}</span>
                </div>
            `).join('');
        }
    }

    // Photos upload
    photosUploadBtn?.addEventListener('click', () => photosInput.click());
    photosCameraBtn?.addEventListener('click', () => photosCameraInput.click());

    photosInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handlePhotosUpload(files);
    });

    photosCameraInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handlePhotosUpload(files);
    });

    // Drag and drop for photos
    photosUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        photosUploadArea.classList.add('dragover');
    });

    photosUploadArea.addEventListener('dragleave', () => {
        photosUploadArea.classList.remove('dragover');
    });

    photosUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        photosUploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
        handlePhotosUpload(files);
    });

    function handlePhotosUpload(files) {
        const maxFiles = 10;
        const maxSize = 5 * 1024 * 1024; // 5MB

        files.forEach(file => {
            if (uploadedPhotos.length >= maxFiles) {
                showToast('× ×™×ª×Ÿ ×œ×”×¢×œ×•×ª ×¢×“ 10 ×ª××•× ×•×ª', 'warning');
                return;
            }

            if (file.size > maxSize) {
                showToast(`×”×§×•×‘×¥ ${file.name} ×’×“×•×œ ××“×™ (××§×¡×™××•× 5MB)`, 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedPhotos.push({
                    file: file,
                    preview: e.target.result
                });
                renderPhotosPreview();
            };
            reader.readAsDataURL(file);
        });
    }

    function renderPhotosPreview() {
        photosPreview.innerHTML = uploadedPhotos.map((photo, index) => `
            <div class="photo-preview-item">
                <img src="${photo.preview}" alt="Preview">
                <button type="button" class="remove-photo" data-index="${index}">&times;</button>
            </div>
        `).join('');

        // Add remove handlers
        document.querySelectorAll('.remove-photo').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = parseInt(e.target.dataset.index);
                uploadedPhotos.splice(index, 1);
                renderPhotosPreview();
            });
        });
    }

    // Delivery Note upload
    deliveryNoteUploadBtn?.addEventListener('click', () => deliveryNoteInput.click());
    deliveryNoteCameraBtn?.addEventListener('click', () => deliveryNoteCameraInput.click());

    // Drag and drop for delivery note
    deliveryNoteUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        deliveryNoteUploadArea.classList.add('dragover');
    });

    deliveryNoteUploadArea.addEventListener('dragleave', () => {
        deliveryNoteUploadArea.classList.remove('dragover');
    });

    deliveryNoteUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        deliveryNoteUploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) {
            handleDeliveryNoteUpload(file);
        }
    });

    deliveryNoteInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleDeliveryNoteUpload(file);
        }
    });

    deliveryNoteCameraInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleDeliveryNoteUpload(file);
        }
    });

    function handleDeliveryNoteUpload(file) {
        const maxSize = 10 * 1024 * 1024; // 10MB
        const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
        const allowedExtensions = ['.pdf', '.jpg', '.jpeg', '.png'];

        // Check file extension
        const fileName = file.name.toLowerCase();
        const hasValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));

        if (!hasValidExtension && !allowedTypes.includes(file.type)) {
            showToast('×¡×•×’ ×§×•×‘×¥ ×œ× ×—×•×§×™. ×™×© ×œ×”×¢×œ×•×ª PDF ××• ×ª××•× ×” (jpg, png)', 'error');
            return;
        }

        if (file.size > maxSize) {
            showToast('×”×§×•×‘×¥ ×’×“×•×œ ××“×™ (××§×¡×™××•× 10MB)', 'error');
            return;
        }

        uploadedDeliveryNote = file;
        deliveryNoteError.style.display = 'none';

        const isPDF = file.type === 'application/pdf' || fileName.endsWith('.pdf');
        const isImage = file.type.startsWith('image/') || ['.jpg', '.jpeg', '.png'].some(ext => fileName.endsWith(ext));

        let previewHtml = `
            <div class="delivery-note-preview-item">
                <span class="doc-icon">${isPDF ? 'ğŸ“„' : 'ğŸ–¼ï¸'}</span>
                <span class="doc-name">${escapeHtml(file.name)}</span>
                <span class="doc-size">(${formatFileSize(file.size)})</span>
                <button type="button" class="remove-doc" id="removeDeliveryNote">&times;</button>
            </div>
        `;

        // If it's an image, show thumbnail preview
        if (isImage) {
            const reader = new FileReader();
            reader.onload = (e) => {
                deliveryNotePreview.innerHTML = `
                    <div class="delivery-note-preview-item with-thumbnail">
                        <img src="${e.target.result}" alt="Preview" class="doc-thumbnail">
                        <div class="doc-info">
                            <span class="doc-name">${escapeHtml(file.name)}</span>
                            <span class="doc-size">(${formatFileSize(file.size)})</span>
                        </div>
                        <button type="button" class="remove-doc" id="removeDeliveryNote">&times;</button>
                    </div>
                `;
                addRemoveDeliveryNoteHandler();
            };
            reader.readAsDataURL(file);
        } else {
            deliveryNotePreview.innerHTML = previewHtml;
            addRemoveDeliveryNoteHandler();
        }
    }

    function addRemoveDeliveryNoteHandler() {
        document.getElementById('removeDeliveryNote').addEventListener('click', () => {
            uploadedDeliveryNote = null;
            deliveryNotePreview.innerHTML = '';
            deliveryNoteInput.value = '';
        });
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // Form submission
    reportForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Validate form
        const reportType = document.querySelector('input[name="report_type"]:checked')?.value;
        const address = document.getElementById('address').value.trim();
        const status = document.querySelector('input[name="status"]:checked')?.value;
        const notes = document.getElementById('notes').value.trim();

        // Delivery / Installation extra fields
        const customerName = customerNameInput ? customerNameInput.value.trim() : '';
        const reportDateTime = reportDateInput ? reportDateInput.value : '';
        const installationTypes = reportType === 'installation' ? getSelectedInstallationTypes() : [];

        if (!reportType) {
            showToast('×™×© ×œ×‘×—×•×¨ ×¡×•×’ ×“×•×—', 'error');
            return;
        }

        if (!address) {
            showToast('×™×© ×œ×”×–×™×Ÿ ×›×ª×•×‘×ª', 'error');
            return;
        }

        if (!customerName) {
            showToast('×™×© ×œ×”×–×™×Ÿ ×©× ×œ×§×•×—', 'error');
            customerNameInput.focus();
            return;
        }

        if (!reportDateTime) {
            showToast('×™×© ×œ×‘×—×•×¨ ×ª××¨×™×š ×•×©×¢×”', 'error');
            reportDateInput.focus();
            return;
        }

        // Installation validations
        if (reportType === 'installation') {
            if (!installationTypes || installationTypes.length === 0) {
                showToast('×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ×¡×•×’ ×”×ª×§× ×” ××—×“', 'error');
                const firstCheckbox = installationTypesWrap?.querySelector('input[type="checkbox"]');
                if (firstCheckbox) firstCheckbox.focus();
                return;
            }
        }

        if (selectedProducts.length === 0) {
            showToast('×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ××•×¦×¨ ××—×“ ×¢× ×›××•×ª', 'error');
            return;
        }

        if (!status) {
            showToast('×™×© ×œ×‘×—×•×¨ ×¡×˜×˜×•×¡', 'error');
            return;
        }

        // Validate delivery note for delivery reports (MANDATORY)
        if (reportType === 'delivery' && !uploadedDeliveryNote) {
            showToast('×™×© ×œ×”×¢×œ×•×ª ×ª×¢×•×“×ª ××©×œ×•×— ×—×ª×•××” ×¢×‘×•×¨ ×“×•×— ××¡×¤×§×”', 'error');
            deliveryNoteError.style.display = 'flex';
            deliveryNoteSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        // Show loading
        submitBtn.querySelector('.btn-text').style.display = 'none';
        submitBtn.querySelector('.btn-loading').style.display = 'flex';
        submitBtn.disabled = true;

        // Check if online
        if (!navigator.onLine) {
            // Save offline
            saveOfflineReport({
                report_type: reportType,
                address: address,
                customer_name: customerName,
                company_project: companyProjectInput ? companyProjectInput.value.trim() : '',
                report_datetime: reportDateTime,
                status: status,
                notes: notes,
                installation_types: installationTypes,
                products: selectedProducts,
                timestamp: new Date().toISOString()
            });
            showToast('×”×“×•×— × ×©××¨ ××§×•××™×ª ×•×™×¡×•× ×›×¨×Ÿ ×›×©×ª×”×™×” ×ª×§×©×•×¨×ª', 'info');
            setTimeout(() => window.location.href = '/dashboard', 2000);
            return;
        }

        // Create FormData
        const formData = new FormData();
        formData.append('report_type', reportType);
        formData.append('address', address);
        formData.append('status', status);
        formData.append('notes', notes);
        formData.append('customer_name', customerName);
        formData.append('company_project', companyProjectInput ? companyProjectInput.value.trim() : '');
        formData.append('report_datetime', reportDateTime);
        formData.append('products', JSON.stringify(selectedProducts));

        // Installation extra fields
        if (reportType === 'installation') {
            formData.append('installation_types', JSON.stringify(installationTypes));
        }

        // Add photos
        uploadedPhotos.forEach(photo => {
            formData.append('images', photo.file);
        });

        // Add delivery note (mandatory for delivery reports)
        if (uploadedDeliveryNote && reportType === 'delivery') {
            formData.append('delivery_note', uploadedDeliveryNote);
        }

        try {
            const response = await fetch('/api/reports', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showToast('×”×“×•×— × ×©××¨ ×‘×”×¦×œ×—×”!', 'success');
                setTimeout(() => {
                    window.location.href = `/report/${data.report_id}`;
                }, 1500);
            } else {
                showToast(data.error || '×©×’×™××” ×‘×©××™×¨×ª ×”×“×•×—', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            // Save offline on network error
            saveOfflineReport({
                report_type: reportType,
                address: address,
                customer_name: customerName,
                company_project: companyProjectInput ? companyProjectInput.value.trim() : '',
                report_datetime: reportDateTime,
                status: status,
                notes: notes,
                installation_types: installationTypes,
                products: selectedProducts,
                timestamp: new Date().toISOString()
            });
            showToast('×©×’×™××ª ×ª×§×©×•×¨×ª - ×”×“×•×— × ×©××¨ ××§×•××™×ª', 'warning');
        } finally {
            submitBtn.querySelector('.btn-text').style.display = 'block';
            submitBtn.querySelector('.btn-loading').style.display = 'none';
            submitBtn.disabled = false;
        }
    });

    function saveOfflineReport(report) {
        const offlineReports = JSON.parse(localStorage.getItem('offlineReports') || '[]');
        offlineReports.push(report);
        localStorage.setItem('offlineReports', JSON.stringify(offlineReports));
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
