{% extends "base.html" %}

{% block title %}{% if edit_mode %}עריכת דוח{% else %}דוח חדש{% endif %} - Proshield Reports{% endblock %}

{% block content %}
<div class="new-report-page">
    <div class="page-header">
        <a href="{{ url_for('dashboard') }}" class="back-link">◀ חזרה לדוחות</a>
        <h1>{% if edit_mode %}✏️ עריכת דוח{% else %}📝 דוח חדש{% endif %}</h1>
    </div>

    <form id="reportForm" class="report-form" data-report-id="{{ report_id or '' }}" data-edit-mode="{{ 'true' if edit_mode else 'false' }}">
        <!-- Step 1: Report Type -->
        <div class="form-section">
            <h2>1. סוג דוח</h2>
            <div class="report-type-selector">
                <label class="type-option">
                    <input type="radio" name="report_type" value="delivery" required>
                    <div class="type-card">
                        <span class="type-icon">🚚</span>
                        <span class="type-label">אספקה</span>
                    </div>
                </label>
                <label class="type-option">
                    <input type="radio" name="report_type" value="installation" required>
                    <div class="type-card">
                        <span class="type-icon">🔧</span>
                        <span class="type-label">התקנה</span>
                    </div>
                </label>
            </div>


        </div>

        <!-- Step 2: Address + Customer + Date/Time -->
        <div class="form-section">
            <h2>2. <span id="addressLabel">כתובת</span></h2>
            <div class="form-group">
                <input type="text" id="address" name="address" placeholder="הזן כתובת..." required>
            </div>

            <div class="form-group" id="customerNameWrap" style="display:none;">
                <label for="customer_name">שם לקוח <span class="required-badge">חובה</span></label>
                <input type="text" id="customer_name" name="customer_name" placeholder="הזן שם לקוח...">
            </div>

            <div class="form-group" id="recipientNameWrap" style="display:none;">
                <label for="recipient_name">שם מקבל הסחורה <span class="optional-badge">אופציונלי</span></label>
                <input type="text" id="recipient_name" name="recipient_name" placeholder="הזן שם מקבל הסחורה...">
            </div>

            <div class="form-group" id="companyProjectWrap" style="display:none;">
                <label>חברת בניה/פרויקט <span class="optional-badge">אופציונלי</span></label>
                <input type="hidden" id="company_project" name="company_project">
                <button type="button" class="dropdown-toggle" id="companyProjectToggle">בחר חברת בניה/פרויקט</button>
                <div class="dropdown-content" id="companyProjectDropdown">
                    <input type="text" id="companyProjectSearch" placeholder="חפש...">
                    <div class="company-project-list" id="companyProjectList"></div>
                </div>
            </div>

            <div class="form-group" id="reportDateWrap" style="display:none;">
                <label for="report_datetime">תאריך ושעה <span class="required-badge">חובה</span></label>
                <input type="datetime-local" id="report_datetime" name="report_datetime">
            </div>

            <div class="installation-details" id="installationDetails" style="display:none;">
                <h3>סוג התקנה</h3>

                <div class="form-group">
                    <label>בחר סוג/ים של התקנה</label>
                    <button type="button" class="dropdown-toggle" id="installationTypesToggle">בחר סוגי התקנה</button>
                    <div class="dropdown-content installation-types" id="installationTypesWrap">
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="הגנת מדרגות">
                            <span>הגנת מדרגות</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="הגנת פרקט">
                            <span>הגנת פרקט</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="הגנת ריצוף">
                            <span>הגנת ריצוף</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="הגנת מטבח">
                            <span>הגנת מטבח</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="הגנת חלונות">
                            <span>הגנת חלונות</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="הגנה לדלת כניסה">
                            <span>הגנה לדלת כניסה</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="הגנה לדלת פנים">
                            <span>הגנה לדלת פנים</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="הגנה לריצוף חוץ">
                            <span>הגנה לריצוף חוץ</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="הגנה לנגרויות">
                            <span>הגנה לנגרויות</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="הגנת מעלית">
                            <span>הגנת מעלית</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="הגנת פרופילי חלון">
                            <span>הגנת פרופילי חלון</span>
                        </label>
                        <label class="install-type-item">
                            <input type="checkbox" name="installation_types" value="הגנת מעקות">
                            <span>הגנת מעקות</span>
                        </label>
                        <div class="custom-entry-section">
                            <label class="install-type-item custom-toggle">
                                <input type="checkbox" id="customInstallationToggle">
                                <span>אחר (הזן ידנית)</span>
                            </label>
                            <div class="custom-entry-fields" id="customInstallationFields" style="display:none;">
                                <div class="custom-entry-row">
                                    <input type="text" id="customInstallationInput" class="custom-entry-input" placeholder="הזן סוג התקנה...">
                                    <button type="button" class="btn btn-sm btn-primary custom-add-btn" id="addCustomInstallation">+ הוסף</button>
                                </div>
                                <div class="custom-entries-list" id="customInstallationList"></div>
                            </div>
                        </div>
                    </div>
                    <small>ניתן לבחור יותר מסוג אחד</small>
                </div>

                <div class="form-group" id="installationTeamWrap">
                    <label>צוות התקנה <span class="required-badge">חובה</span></label>
                    <div class="installation-team-selector">
                        <label class="team-option">
                            <input type="radio" name="installation_team" value="solo">
                            <div class="team-card">
                                <span class="team-label">רק אני</span>
                            </div>
                        </label>
                        <label class="team-option">
                            <input type="radio" name="installation_team" value="with_worker">
                            <div class="team-card">
                                <span class="team-label">אני ועובד נוסף</span>
                            </div>
                        </label>
                    </div>
                    <div class="form-group" id="additionalWorkerWrap" style="display:none;">
                        <label for="additional_worker_name">שם העובד הנוסף <span class="required-badge">חובה</span></label>
                        <input type="text" id="additional_worker_name" name="additional_worker_name" placeholder="הזן שם העובד הנוסף...">
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Products -->
        <div class="form-section">
            <h2>3. מוצרים</h2>
            <div class="products-selector">
                <button type="button" class="dropdown-toggle" id="productsToggle">בחר מוצרים</button>
                <div class="dropdown-content" id="productsDropdown">
                    <div class="products-search">
                        <input type="text" id="productSearch" placeholder="🔍 חפש מוצר...">
                    </div>
                    <div class="products-list" id="productsList">
                        {% for product in products %}
                        <label class="product-item">
                            <input type="checkbox" name="products" value="{{ product }}">
                            <span class="product-name">{{ product }}</span>
                            <div class="product-quantity" style="display:none;">
                                <label id="quantityLabel">כמות:</label>
                                <div class="quantity-row">
                                    <input type="number" step="0.1" min="0" placeholder="0" class="quantity-input">
                                    <select class="quantity-unit">
                                        <option value="meter" selected>מטר</option>
                                        <option value="unit">יחידה</option>
                                    </select>
                                </div>
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="custom-entry-section custom-product-section">
                        <div class="custom-entry-header" id="customProductToggleBtn">
                            <span>+ הוסף מוצר שלא ברשימה</span>
                        </div>
                        <div class="custom-entry-fields" id="customProductFields" style="display:none;">
                            <div class="custom-entry-row">
                                <input type="text" id="customProductNameInput" class="custom-entry-input" placeholder="שם המוצר...">
                            </div>
                            <div class="custom-entry-row">
                                <input type="number" id="customProductQuantityInput" step="0.1" min="0" placeholder="כמות" class="custom-entry-input quantity-input">
                                <select id="customProductUnitInput" class="quantity-unit">
                                    <option value="meter" selected>מטר</option>
                                    <option value="unit">יחידה</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-primary custom-add-btn" id="addCustomProduct">+ הוסף</button>
                            </div>
                            <div class="custom-entries-list" id="customProductList"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="selected-products" id="selectedProducts">
                <h3>מוצרים שנבחרו:</h3>
                <div class="selected-list" id="selectedList">
                    <p class="no-selection">לא נבחרו מוצרים</p>
                </div>
            </div>
        </div>

        <!-- Step 4: Status -->
        <div class="form-section">
            <h2>4. סטטוס</h2>
            <div class="status-selector">
                <label class="status-option">
                    <input type="radio" name="status" value="completed" required>
                    <div class="status-card completed">
                        <span class="status-icon">✅</span>
                        <span class="status-label">הושלם</span>
                    </div>
                </label>
                <label class="status-option">
                    <input type="radio" name="status" value="return_required" required>
                    <div class="status-card return">
                        <span class="status-icon">🔄</span>
                        <span class="status-label">נדרש חזרה</span>
                    </div>
                </label>
            </div>
        </div>

        <!-- Step 5: Photos -->
        <div class="form-section">
            <h2>5. <span id="photosLabel">תמונות</span></h2>
            <div class="photos-upload">
                <div class="upload-area" id="photosUploadArea">
                    <input type="file" id="photosInput" name="images" accept="image/*" multiple style="display:none;">
                    <input type="file" id="photosCameraInput" accept="image/*" capture="environment" multiple style="display:none;">
                    <div class="upload-placeholder">
                        <span class="upload-icon">📷</span>
                        <span class="upload-text">צילום או העלאת תמונות</span>
                        <div class="upload-actions">
                            <button type="button" class="btn btn-secondary btn-sm" id="photosCameraBtn">צלם תמונה</button>
                            <button type="button" class="btn btn-primary btn-sm" id="photosUploadBtn">העלה תמונות</button>
                        </div>
                        <span class="upload-hint">עד 10 תמונות, 5MB כל אחת</span>
                    </div>
                </div>
                <div class="photos-preview" id="photosPreview"></div>
            </div>
        </div>

        <!-- Step 6: Delivery Note (Delivery Only - OPTIONAL) -->
        <div class="form-section delivery-note-section" id="deliveryNoteSection" style="display:none;">
            <h2>6. תעודת משלוח חתומה <span class="optional-badge">אופציונלי</span></h2>
            <div class="delivery-note-upload">
                <div class="upload-area" id="deliveryNoteUploadArea">
                    <input type="file" id="deliveryNoteInput" name="delivery_note" accept=".pdf,.jpg,.jpeg,.png,image/*" style="display:none;">
                    <input type="file" id="deliveryNoteCameraInput" accept="image/*" capture="environment" style="display:none;">
                    <div class="upload-placeholder">
                        <span class="upload-icon">📄</span>
                        <span class="upload-text">צילום או העלאת תעודת משלוח חתומה</span>
                        <div class="upload-actions">
                            <button type="button" class="btn btn-secondary btn-sm" id="deliveryNoteCameraBtn">צלם מסמך</button>
                            <button type="button" class="btn btn-primary btn-sm" id="deliveryNoteUploadBtn">העלה קובץ</button>
                        </div>
                        <span class="upload-hint">PDF או תמונה (jpg, png), עד 10MB</span>
                    </div>
                </div>
                <div class="delivery-note-preview" id="deliveryNotePreview"></div>
                <div class="delivery-note-error" id="deliveryNoteError" style="display:none;">
                    <span class="error-icon">⚠️</span>
                    <span class="error-text">יש להעלות תעודת משלוח חתומה</span>
                </div>
            </div>
        </div>

        <!-- Step 7: Notes -->
        <div class="form-section">
            <h2 id="notesStepLabel">6. הערות (אופציונלי)</h2>
            <div class="form-group">
                <textarea id="notes" name="notes" rows="3" placeholder="הערות נוספות..."></textarea>
            </div>
        </div>

        <!-- Submit -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg btn-block" id="submitBtn">
                <span class="btn-text">💾 שמור דוח</span>
                <span class="btn-loading" style="display:none;">
                    <span class="spinner"></span>
                    שומר...
                </span>
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // DOM Elements
    const reportForm = document.getElementById('reportForm');
    const reportTypeInputs = document.querySelectorAll('input[name="report_type"]');
    const addressLabel = document.getElementById('addressLabel');
    const photosLabel = document.getElementById('photosLabel');
    const documentSection = document.getElementById('documentSection');
    const notesStepLabel = document.getElementById('notesStepLabel');
    const productSearch = document.getElementById('productSearch');
    const productItems = document.querySelectorAll('.product-item');
    const photosInput = document.getElementById('photosInput');
    const photosCameraInput = document.getElementById('photosCameraInput');
    const photosUploadArea = document.getElementById('photosUploadArea');
    const photosUploadBtn = document.getElementById('photosUploadBtn');
    const photosCameraBtn = document.getElementById('photosCameraBtn');
    const photosPreview = document.getElementById('photosPreview');
    const deliveryNoteInput = document.getElementById('deliveryNoteInput');
    const deliveryNoteCameraInput = document.getElementById('deliveryNoteCameraInput');
    const deliveryNoteUploadArea = document.getElementById('deliveryNoteUploadArea');
    const deliveryNoteUploadBtn = document.getElementById('deliveryNoteUploadBtn');
    const deliveryNoteCameraBtn = document.getElementById('deliveryNoteCameraBtn');
    const deliveryNotePreview = document.getElementById('deliveryNotePreview');
    const deliveryNoteSection = document.getElementById('deliveryNoteSection');
    const deliveryNoteError = document.getElementById('deliveryNoteError');
    const submitBtn = document.getElementById('submitBtn');

    // Installation details
    const installationDetails = document.getElementById('installationDetails');
    const installationTypesWrap = document.getElementById('installationTypesWrap');
    const installationTypesToggle = document.getElementById('installationTypesToggle');

    // Recipient name (delivery)
    const recipientNameWrap = document.getElementById('recipientNameWrap');
    const recipientNameInput = document.getElementById('recipient_name');

    // Installation team
    const installationTeamInputs = document.querySelectorAll('input[name="installation_team"]');
    const additionalWorkerWrap = document.getElementById('additionalWorkerWrap');
    const additionalWorkerNameInput = document.getElementById('additional_worker_name');

    // Products dropdown
    const productsToggle = document.getElementById('productsToggle');
    const productsDropdown = document.getElementById('productsDropdown');

    // Delivery / Installation extra fields
    const customerNameWrap = document.getElementById('customerNameWrap');
    const customerNameInput = document.getElementById('customer_name');
    const companyProjectWrap = document.getElementById('companyProjectWrap');
    const companyProjectInput = document.getElementById('company_project');
    const companyProjectToggle = document.getElementById('companyProjectToggle');
    const companyProjectDropdown = document.getElementById('companyProjectDropdown');
    const companyProjectSearch = document.getElementById('companyProjectSearch');
    const companyProjectList = document.getElementById('companyProjectList');
    const reportDateWrap = document.getElementById('reportDateWrap');
    const reportDateInput = document.getElementById('report_datetime');

    // Selected products data
    let selectedProducts = [];
    let uploadedPhotos = [];
    let uploadedDeliveryNote = null;

    // Custom manual entries
    let customInstallationTypes = [];
    let customProducts = [];

    const editMode = reportForm.dataset.editMode === 'true';
    const editReportId = reportForm.dataset.reportId;

    if (editMode) {
        const btnText = submitBtn.querySelector('.btn-text');
        if (btnText) btnText.textContent = '💾 עדכן דוח';
    }

    loadCompanyProjects();
    loadReportForEdit();

    function toggleDropdown(contentEl) {
        if (!contentEl) return;
        contentEl.classList.toggle('open');
    }

    installationTypesToggle?.addEventListener('click', () => toggleDropdown(installationTypesWrap));
    productsToggle?.addEventListener('click', () => toggleDropdown(productsDropdown));
    companyProjectToggle?.addEventListener('click', () => toggleDropdown(companyProjectDropdown));

    // Installation team radio handler
    installationTeamInputs.forEach(input => {
        input.addEventListener('change', (e) => {
            if (e.target.value === 'with_worker') {
                additionalWorkerWrap.style.display = 'block';
                additionalWorkerNameInput.required = true;
                additionalWorkerNameInput.focus();
            } else {
                additionalWorkerWrap.style.display = 'none';
                additionalWorkerNameInput.required = false;
                additionalWorkerNameInput.value = '';
            }
        });
    });

    productSearch.addEventListener('focus', () => {
        if (productsDropdown) {
            productsDropdown.classList.add('open');
        }
    });

    companyProjectSearch?.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const items = companyProjectList?.querySelectorAll('.company-project-item') || [];
        items.forEach(item => {
            const name = item.textContent.toLowerCase();
            item.style.display = name.includes(term) ? 'block' : 'none';
        });
    });

    function resetInstallationFields() {
        if (installationTypesWrap) {
            installationTypesWrap.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }
        // Reset custom installation types
        customInstallationTypes = [];
        const customInstList = document.getElementById('customInstallationList');
        if (customInstList) customInstList.innerHTML = '';
        const customInstToggle = document.getElementById('customInstallationToggle');
        if (customInstToggle) customInstToggle.checked = false;
        const customInstFields = document.getElementById('customInstallationFields');
        if (customInstFields) customInstFields.style.display = 'none';

        // Reset installation team
        installationTeamInputs.forEach(input => { input.checked = false; });
        if (additionalWorkerWrap) additionalWorkerWrap.style.display = 'none';
        if (additionalWorkerNameInput) {
            additionalWorkerNameInput.value = '';
            additionalWorkerNameInput.required = false;
        }
    }

    function setDefaultReportDateTime() {
        if (!reportDateInput) return;
        if (reportDateInput.value) return;

        const now = new Date();
        const pad = (n) => String(n).padStart(2, '0');
        const localValue = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
        reportDateInput.value = localValue;
    }

    async function loadCompanyProjects() {
        if (!companyProjectList) return;

        try {
            const response = await fetch('/api/company-projects');
            const data = await response.json();
            const projects = data.projects || [];

            renderCompanyProjects(projects);
        } catch (error) {
            console.error('Error loading company/project list:', error);
        }
    }

    function renderCompanyProjects(projects) {
        companyProjectList.innerHTML = projects.map(p => `
            <button type="button" class="company-project-item" data-value="${escapeHtml(p.name)}">${escapeHtml(p.name)}</button>
        `).join('');

        companyProjectList.querySelectorAll('.company-project-item').forEach(btn => {
            btn.addEventListener('click', () => {
                const value = btn.dataset.value || '';
                if (companyProjectInput) companyProjectInput.value = value;
                if (companyProjectToggle) companyProjectToggle.textContent = value || 'בחר חברת בניה/פרויקט';
                companyProjectDropdown?.classList.remove('open');
            });
        });
    }

    async function loadReportForEdit() {
        if (!editMode || !editReportId) return;

        try {
            const response = await fetch(`/api/reports/${editReportId}`);
            const data = await response.json();
            if (!data || !data.id) return;

            // Set type
            const typeInput = document.querySelector(`input[name="report_type"][value="${data.report_type}"]`);
            if (typeInput) {
                typeInput.checked = true;
                typeInput.dispatchEvent(new Event('change'));
            }

            // Basic fields
            document.getElementById('address').value = data.address || '';
            if (customerNameInput) customerNameInput.value = data.customer_name || '';
            if (recipientNameInput) recipientNameInput.value = data.recipient_name || '';
            if (companyProjectInput) companyProjectInput.value = data.company_project || '';
            if (companyProjectToggle) companyProjectToggle.textContent = data.company_project || 'בחר חברת בניה/פרויקט';
            if (reportDateInput && data.timestamp) {
                const dt = new Date(data.timestamp);
                const pad = (n) => String(n).padStart(2, '0');
                reportDateInput.value = `${dt.getFullYear()}-${pad(dt.getMonth() + 1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
            }

            // Status
            const statusInput = document.querySelector(`input[name="status"][value="${data.status}"]`);
            if (statusInput) statusInput.checked = true;

            // Installation types
            if (data.report_type === 'installation' && data.installation_types) {
                let types = [];
                try {
                    types = JSON.parse(data.installation_types);
                } catch (e) {
                    types = [];
                }
                if (Array.isArray(types)) {
                    types.forEach(t => {
                        const cb = document.querySelector(`input[name="installation_types"][value="${CSS.escape(t)}"]`);
                        if (cb) {
                            cb.checked = true;
                        } else {
                            // Custom installation type not in predefined list
                            customInstallationTypes.push(t);
                        }
                    });
                    if (customInstallationTypes.length > 0) {
                        const toggle = document.getElementById('customInstallationToggle');
                        if (toggle) toggle.checked = true;
                        const fields = document.getElementById('customInstallationFields');
                        if (fields) fields.style.display = 'block';
                        renderCustomInstallationTypes();
                    }
                }
            }

            // Installation team
            if (data.report_type === 'installation' && data.installation_team) {
                const teamInput = document.querySelector(`input[name="installation_team"][value="${data.installation_team}"]`);
                if (teamInput) {
                    teamInput.checked = true;
                    teamInput.dispatchEvent(new Event('change'));
                }
                if (data.installation_team === 'with_worker' && data.additional_worker_name) {
                    if (additionalWorkerNameInput) additionalWorkerNameInput.value = data.additional_worker_name;
                }
            }

            // Products
            if (Array.isArray(data.products)) {
                data.products.forEach(p => {
                    const checkbox = document.querySelector(`input[name="products"][value="${CSS.escape(p.product_name)}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        const item = checkbox.closest('.product-item');
                        const quantityDiv = item?.querySelector('.product-quantity');
                        const quantityInput = item?.querySelector('.quantity-input');
                        const unitSelect = item?.querySelector('.quantity-unit');
                        if (quantityDiv) quantityDiv.style.display = 'flex';
                        if (quantityInput) quantityInput.value = p.quantity ?? '';
                        if (unitSelect) unitSelect.value = p.quantity_unit || 'meter';
                    } else {
                        // Custom product not in predefined list
                        customProducts.push({
                            name: p.product_name,
                            quantity: p.quantity || 0,
                            unit: p.quantity_unit || 'meter'
                        });
                    }
                });
                if (customProducts.length > 0) {
                    const cpFields = document.getElementById('customProductFields');
                    if (cpFields) cpFields.style.display = 'block';
                    renderCustomProducts();
                }
                updateSelectedProducts();
            }

            if (productsDropdown) {
                productsDropdown.classList.add('open');
            }
        } catch (error) {
            console.error('Error loading report for edit:', error);
        }
    }

    function getSelectedInstallationTypes() {
        const checked = Array.from(document.querySelectorAll('input[name="installation_types"]:checked'))
            .map(cb => cb.value);
        return checked.concat(customInstallationTypes);
    }

    // Report type change handler
    reportTypeInputs.forEach(input => {
        input.addEventListener('change', (e) => {
            const type = e.target.value;

            if (type === 'delivery') {
                addressLabel.textContent = 'כתובת אספקה';
                photosLabel.textContent = 'תמונות סחורה שסופקה';
                deliveryNoteSection.style.display = 'block';
                notesStepLabel.textContent = '7. הערות (אופציונלי)';
                updateQuantityLabels('כמות שסופקה:');

                // Customer + Date/Time are mandatory
                customerNameWrap.style.display = 'block';
                customerNameInput.required = true;
                companyProjectWrap.style.display = 'block';
                reportDateWrap.style.display = 'block';
                reportDateInput.required = true;
                setDefaultReportDateTime();

                // Show recipient name (optional, delivery only)
                recipientNameWrap.style.display = 'block';

                // Hide installation details
                installationDetails.style.display = 'none';
                resetInstallationFields();
            } else {
                addressLabel.textContent = 'כתובת התקנה';
                photosLabel.textContent = 'תמונות הפרויקט';
                deliveryNoteSection.style.display = 'none';
                notesStepLabel.textContent = '6. הערות (אופציונלי)';
                updateQuantityLabels('כמות שהותקנה:');

                // Installation: show customer + date
                customerNameWrap.style.display = 'block';
                customerNameInput.required = true;
                companyProjectWrap.style.display = 'block';
                reportDateWrap.style.display = 'block';
                reportDateInput.required = true;
                setDefaultReportDateTime();

                // Hide recipient name (delivery only)
                recipientNameWrap.style.display = 'none';
                if (recipientNameInput) recipientNameInput.value = '';

                // Clear delivery note error when switching to installation
                deliveryNoteError.style.display = 'none';

                // Show installation details before products
                installationDetails.style.display = 'block';
                resetInstallationFields();
            }
        });
    });



    function updateQuantityLabels(text) {
        document.querySelectorAll('.product-quantity label').forEach(label => {
            label.textContent = text;
        });
    }

    // Product search
    productSearch.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        productItems.forEach(item => {
            const productName = item.querySelector('.product-name').textContent.toLowerCase();
            item.style.display = productName.includes(searchTerm) ? 'flex' : 'none';
        });
    });

    // Product selection
    productItems.forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        const quantityDiv = item.querySelector('.product-quantity');
        const quantityInput = item.querySelector('.quantity-input');

        checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
                quantityDiv.style.display = 'flex';
                const unitSelect = item.querySelector('.quantity-unit');
                if (unitSelect) unitSelect.value = 'meter';
                quantityInput.focus();
            } else {
                quantityDiv.style.display = 'none';
                quantityInput.value = '';
            }
            updateSelectedProducts();
        });

        quantityInput.addEventListener('input', updateSelectedProducts);
    });

    function updateSelectedProducts() {
        selectedProducts = [];
        const selectedList = document.getElementById('selectedList');

        productItems.forEach(item => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            const quantityInput = item.querySelector('.quantity-input');

            if (checkbox.checked && quantityInput.value) {
                const unitSelect = item.querySelector('.quantity-unit');
                selectedProducts.push({
                    name: checkbox.value,
                    quantity: parseFloat(quantityInput.value) || 0,
                    unit: unitSelect ? unitSelect.value : 'unit'
                });
            }
        });

        // Add custom (manual) products
        customProducts.forEach(cp => {
            selectedProducts.push({
                name: cp.name,
                quantity: cp.quantity,
                unit: cp.unit
            });
        });

        if (selectedProducts.length === 0) {
            selectedList.innerHTML = '<p class="no-selection">לא נבחרו מוצרים</p>';
        } else {
            selectedList.innerHTML = selectedProducts.map(p => `
                <div class="selected-item">
                    <span class="item-name">${escapeHtml(p.name)}</span>
                    <span class="item-qty">${p.quantity} ${p.unit === 'meter' ? 'מ׳' : 'יח׳'}</span>
                </div>
            `).join('');
        }
    }

    // Photos upload
    photosUploadBtn?.addEventListener('click', () => photosInput.click());
    photosCameraBtn?.addEventListener('click', () => photosCameraInput.click());

    photosInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handlePhotosUpload(files);
    });

    photosCameraInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handlePhotosUpload(files);
    });

    // Drag and drop for photos
    photosUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        photosUploadArea.classList.add('dragover');
    });

    photosUploadArea.addEventListener('dragleave', () => {
        photosUploadArea.classList.remove('dragover');
    });

    photosUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        photosUploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
        handlePhotosUpload(files);
    });

    function handlePhotosUpload(files) {
        const maxFiles = 10;
        const maxSize = 5 * 1024 * 1024; // 5MB

        files.forEach(file => {
            if (uploadedPhotos.length >= maxFiles) {
                showToast('ניתן להעלות עד 10 תמונות', 'warning');
                return;
            }

            if (file.size > maxSize) {
                showToast(`הקובץ ${file.name} גדול מדי (מקסימום 5MB)`, 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedPhotos.push({
                    file: file,
                    preview: e.target.result
                });
                renderPhotosPreview();
            };
            reader.readAsDataURL(file);
        });
    }

    function renderPhotosPreview() {
        photosPreview.innerHTML = uploadedPhotos.map((photo, index) => `
            <div class="photo-preview-item">
                <img src="${photo.preview}" alt="Preview">
                <button type="button" class="remove-photo" data-index="${index}">&times;</button>
            </div>
        `).join('');

        // Add remove handlers
        document.querySelectorAll('.remove-photo').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = parseInt(e.target.dataset.index);
                uploadedPhotos.splice(index, 1);
                renderPhotosPreview();
            });
        });
    }

    // Delivery Note upload
    deliveryNoteUploadBtn?.addEventListener('click', () => deliveryNoteInput.click());
    deliveryNoteCameraBtn?.addEventListener('click', () => deliveryNoteCameraInput.click());

    // Drag and drop for delivery note
    deliveryNoteUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        deliveryNoteUploadArea.classList.add('dragover');
    });

    deliveryNoteUploadArea.addEventListener('dragleave', () => {
        deliveryNoteUploadArea.classList.remove('dragover');
    });

    deliveryNoteUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        deliveryNoteUploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) {
            handleDeliveryNoteUpload(file);
        }
    });

    deliveryNoteInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleDeliveryNoteUpload(file);
        }
    });

    deliveryNoteCameraInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleDeliveryNoteUpload(file);
        }
    });

    function handleDeliveryNoteUpload(file) {
        const maxSize = 10 * 1024 * 1024; // 10MB
        const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
        const allowedExtensions = ['.pdf', '.jpg', '.jpeg', '.png'];

        // Check file extension
        const fileName = file.name.toLowerCase();
        const hasValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));

        if (!hasValidExtension && !allowedTypes.includes(file.type)) {
            showToast('סוג קובץ לא חוקי. יש להעלות PDF או תמונה (jpg, png)', 'error');
            return;
        }

        if (file.size > maxSize) {
            showToast('הקובץ גדול מדי (מקסימום 10MB)', 'error');
            return;
        }

        uploadedDeliveryNote = file;
        deliveryNoteError.style.display = 'none';

        const isPDF = file.type === 'application/pdf' || fileName.endsWith('.pdf');
        const isImage = file.type.startsWith('image/') || ['.jpg', '.jpeg', '.png'].some(ext => fileName.endsWith(ext));

        let previewHtml = `
            <div class="delivery-note-preview-item">
                <span class="doc-icon">${isPDF ? '📄' : '🖼️'}</span>
                <span class="doc-name">${escapeHtml(file.name)}</span>
                <span class="doc-size">(${formatFileSize(file.size)})</span>
                <button type="button" class="remove-doc" id="removeDeliveryNote">&times;</button>
            </div>
        `;

        // If it's an image, show thumbnail preview
        if (isImage) {
            const reader = new FileReader();
            reader.onload = (e) => {
                deliveryNotePreview.innerHTML = `
                    <div class="delivery-note-preview-item with-thumbnail">
                        <img src="${e.target.result}" alt="Preview" class="doc-thumbnail">
                        <div class="doc-info">
                            <span class="doc-name">${escapeHtml(file.name)}</span>
                            <span class="doc-size">(${formatFileSize(file.size)})</span>
                        </div>
                        <button type="button" class="remove-doc" id="removeDeliveryNote">&times;</button>
                    </div>
                `;
                addRemoveDeliveryNoteHandler();
            };
            reader.readAsDataURL(file);
        } else {
            deliveryNotePreview.innerHTML = previewHtml;
            addRemoveDeliveryNoteHandler();
        }
    }

    function addRemoveDeliveryNoteHandler() {
        document.getElementById('removeDeliveryNote').addEventListener('click', () => {
            uploadedDeliveryNote = null;
            deliveryNotePreview.innerHTML = '';
            deliveryNoteInput.value = '';
        });
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // Form submission
    reportForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Validate form
        const reportType = document.querySelector('input[name="report_type"]:checked')?.value;
        const address = document.getElementById('address').value.trim();
        const status = document.querySelector('input[name="status"]:checked')?.value;
        const notes = document.getElementById('notes').value.trim();

        // Delivery / Installation extra fields
        const customerName = customerNameInput ? customerNameInput.value.trim() : '';
        const recipientName = recipientNameInput ? recipientNameInput.value.trim() : '';
        const reportDateTime = reportDateInput ? reportDateInput.value : '';
        const installationTypes = reportType === 'installation' ? getSelectedInstallationTypes() : [];
        const installationTeam = document.querySelector('input[name="installation_team"]:checked')?.value || '';
        const additionalWorkerName = additionalWorkerNameInput ? additionalWorkerNameInput.value.trim() : '';

        if (!reportType) {
            showToast('יש לבחור סוג דוח', 'error');
            return;
        }

        if (!address) {
            showToast('יש להזין כתובת', 'error');
            return;
        }

        if (!customerName) {
            showToast('יש להזין שם לקוח', 'error');
            customerNameInput.focus();
            return;
        }

        if (!reportDateTime) {
            showToast('יש לבחור תאריך ושעה', 'error');
            reportDateInput.focus();
            return;
        }

        // Installation validations
        if (reportType === 'installation') {
            if (!installationTypes || installationTypes.length === 0) {
                showToast('יש לבחור לפחות סוג התקנה אחד', 'error');
                const firstCheckbox = installationTypesWrap?.querySelector('input[type="checkbox"]');
                if (firstCheckbox) firstCheckbox.focus();
                return;
            }

            if (!installationTeam) {
                showToast('יש לבחור צוות התקנה', 'error');
                return;
            }

            if (installationTeam === 'with_worker' && !additionalWorkerName) {
                showToast('יש להזין שם עובד נוסף', 'error');
                additionalWorkerNameInput.focus();
                return;
            }
        }

        if (selectedProducts.length === 0) {
            showToast('יש לבחור לפחות מוצר אחד עם כמות', 'error');
            return;
        }

        if (!status) {
            showToast('יש לבחור סטטוס', 'error');
            return;
        }

        // Delivery note is now optional - no validation required

        // Show loading
        submitBtn.querySelector('.btn-text').style.display = 'none';
        submitBtn.querySelector('.btn-loading').style.display = 'flex';
        submitBtn.disabled = true;

        // Check if online
        if (!navigator.onLine) {
            // Save offline
            saveOfflineReport({
                report_type: reportType,
                address: address,
                customer_name: customerName,
                company_project: companyProjectInput ? companyProjectInput.value.trim() : '',
                report_datetime: reportDateTime,
                status: status,
                notes: notes,
                installation_types: installationTypes,
                products: selectedProducts,
                timestamp: new Date().toISOString()
            });
            showToast('הדוח נשמר מקומית ויסונכרן כשתהיה תקשורת', 'info');
            setTimeout(() => window.location.href = '/dashboard', 2000);
            return;
        }

        // Create FormData
        const formData = new FormData();
        formData.append('report_type', reportType);
        formData.append('address', address);
        formData.append('status', status);
        formData.append('notes', notes);
        formData.append('customer_name', customerName);
        formData.append('company_project', companyProjectInput ? companyProjectInput.value.trim() : '');
        formData.append('recipient_name', recipientName);
        formData.append('report_datetime', reportDateTime);
        formData.append('products', JSON.stringify(selectedProducts));

        // Installation extra fields
        if (reportType === 'installation') {
            formData.append('installation_types', JSON.stringify(installationTypes));
            formData.append('installation_team', installationTeam);
            formData.append('additional_worker_name', additionalWorkerName);
        }

        // Add photos
        uploadedPhotos.forEach(photo => {
            formData.append('images', photo.file);
        });

        // Add delivery note (mandatory for delivery reports)
        if (uploadedDeliveryNote && reportType === 'delivery') {
            formData.append('delivery_note', uploadedDeliveryNote);
        }

        try {
            const endpoint = editMode && editReportId ? `/api/reports/${editReportId}` : '/api/reports';
            const method = editMode && editReportId ? 'PUT' : 'POST';
            const response = await fetch(endpoint, {
                method: method,
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showToast('הדוח נשמר בהצלחה!', 'success');
                setTimeout(() => {
                    window.location.href = `/report/${data.report_id}`;
                }, 1500);
            } else {
                showToast(data.error || 'שגיאה בשמירת הדוח', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            // Save offline on network error
            saveOfflineReport({
                report_type: reportType,
                address: address,
                customer_name: customerName,
                company_project: companyProjectInput ? companyProjectInput.value.trim() : '',
                report_datetime: reportDateTime,
                status: status,
                notes: notes,
                installation_types: installationTypes,
                products: selectedProducts,
                timestamp: new Date().toISOString()
            });
            showToast('שגיאת תקשורת - הדוח נשמר מקומית', 'warning');
        } finally {
            submitBtn.querySelector('.btn-text').style.display = 'block';
            submitBtn.querySelector('.btn-loading').style.display = 'none';
            submitBtn.disabled = false;
        }
    });

    function saveOfflineReport(report) {
        const offlineReports = JSON.parse(localStorage.getItem('offlineReports') || '[]');
        offlineReports.push(report);
        localStorage.setItem('offlineReports', JSON.stringify(offlineReports));
    }

    // ============ Custom Installation Types ============
    const customInstallationToggle = document.getElementById('customInstallationToggle');
    const customInstallationFields = document.getElementById('customInstallationFields');
    const customInstallationInput = document.getElementById('customInstallationInput');
    const addCustomInstallationBtn = document.getElementById('addCustomInstallation');
    const customInstallationList = document.getElementById('customInstallationList');

    customInstallationToggle?.addEventListener('change', () => {
        customInstallationFields.style.display = customInstallationToggle.checked ? 'block' : 'none';
        if (customInstallationToggle.checked) {
            customInstallationInput.focus();
        }
    });

    function addCustomInstallationType(value) {
        const trimmed = (value || '').trim();
        if (!trimmed) return;
        if (customInstallationTypes.includes(trimmed)) {
            showToast('סוג התקנה זה כבר נוסף', 'warning');
            return;
        }
        customInstallationTypes.push(trimmed);
        renderCustomInstallationTypes();
    }

    addCustomInstallationBtn?.addEventListener('click', () => {
        addCustomInstallationType(customInstallationInput.value);
        customInstallationInput.value = '';
        customInstallationInput.focus();
    });

    customInstallationInput?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addCustomInstallationType(customInstallationInput.value);
            customInstallationInput.value = '';
        }
    });

    function renderCustomInstallationTypes() {
        if (!customInstallationList) return;
        customInstallationList.innerHTML = customInstallationTypes.map((t, idx) => `
            <div class="custom-entry-tag">
                <span>${escapeHtml(t)}</span>
                <button type="button" class="custom-entry-remove" data-index="${idx}">&times;</button>
            </div>
        `).join('');

        customInstallationList.querySelectorAll('.custom-entry-remove').forEach(btn => {
            btn.addEventListener('click', () => {
                const index = parseInt(btn.dataset.index);
                customInstallationTypes.splice(index, 1);
                renderCustomInstallationTypes();
            });
        });
    }

    // ============ Custom Products ============
    const customProductToggleBtn = document.getElementById('customProductToggleBtn');
    const customProductFields = document.getElementById('customProductFields');
    const customProductNameInput = document.getElementById('customProductNameInput');
    const customProductQuantityInput = document.getElementById('customProductQuantityInput');
    const customProductUnitInput = document.getElementById('customProductUnitInput');
    const addCustomProductBtn = document.getElementById('addCustomProduct');
    const customProductList = document.getElementById('customProductList');

    customProductToggleBtn?.addEventListener('click', () => {
        const isVisible = customProductFields.style.display !== 'none';
        customProductFields.style.display = isVisible ? 'none' : 'block';
        if (!isVisible) customProductNameInput.focus();
    });

    function addCustomProduct(name, quantity, unit) {
        const trimmedName = (name || '').trim();
        if (!trimmedName) {
            showToast('יש להזין שם מוצר', 'warning');
            return;
        }
        if (!quantity || parseFloat(quantity) <= 0) {
            showToast('יש להזין כמות', 'warning');
            return;
        }
        if (customProducts.some(p => p.name === trimmedName)) {
            showToast('מוצר זה כבר נוסף', 'warning');
            return;
        }
        customProducts.push({
            name: trimmedName,
            quantity: parseFloat(quantity),
            unit: unit || 'meter'
        });
        renderCustomProducts();
        updateSelectedProducts();
    }

    addCustomProductBtn?.addEventListener('click', () => {
        addCustomProduct(
            customProductNameInput.value,
            customProductQuantityInput.value,
            customProductUnitInput.value
        );
        customProductNameInput.value = '';
        customProductQuantityInput.value = '';
        customProductUnitInput.value = 'meter';
        customProductNameInput.focus();
    });

    customProductQuantityInput?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addCustomProductBtn.click();
        }
    });

    function renderCustomProducts() {
        if (!customProductList) return;
        customProductList.innerHTML = customProducts.map((p, idx) => `
            <div class="custom-entry-tag">
                <span>${escapeHtml(p.name)} - ${p.quantity} ${p.unit === 'meter' ? 'מ׳' : 'יח׳'}</span>
                <button type="button" class="custom-entry-remove" data-index="${idx}">&times;</button>
            </div>
        `).join('');

        customProductList.querySelectorAll('.custom-entry-remove').forEach(btn => {
            btn.addEventListener('click', () => {
                const index = parseInt(btn.dataset.index);
                customProducts.splice(index, 1);
                renderCustomProducts();
                updateSelectedProducts();
            });
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
