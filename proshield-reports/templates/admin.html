{% extends "base.html" %}

{% block title %}× ×™×”×•×œ - Proshield Reports{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="page-header">
        <h1>âš™ï¸ ×œ×•×— ×‘×§×¨×” - × ×™×”×•×œ</h1>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="stat-icon">ğŸ“‹</div>
            <div class="stat-value" id="totalReports">-</div>
            <div class="stat-label">×¡×”"×› ×“×•×—×•×ª</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-value" id="completedReports">-</div>
            <div class="stat-label">×”×•×©×œ××•</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ”„</div>
            <div class="stat-value" id="pendingReports">-</div>
            <div class="stat-label">×××ª×™× ×™×</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸšš</div>
            <div class="stat-value" id="deliveryReports">-</div>
            <div class="stat-label">××¡×¤×§×•×ª</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ”§</div>
            <div class="stat-value" id="installationReports">-</div>
            <div class="stat-label">×”×ª×§× ×•×ª</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="admin-tabs">
        <button class="tab-btn active" data-tab="users">ğŸ‘¥ × ×™×”×•×œ ××©×ª××©×™×</button>
        <button class="tab-btn" data-tab="export">ğŸ“¥ ×™×¦×•× × ×ª×•× ×™×</button>
        <button class="tab-btn" data-tab="reports-per-user">ğŸ“Š ×“×•×—×•×ª ×œ×¤×™ ××©×ª××©</button>
        <button class="tab-btn" data-tab="company-projects">ğŸ—ï¸ ×—×‘×¨×•×ª ×‘× ×™×”/×¤×¨×•×™×§×˜×™×</button>
        <button class="tab-btn" data-tab="inventory">ğŸ“¦ ××œ××™ ××—×¡×Ÿ</button>
    </div>

    <!-- Users Tab -->
    <div class="tab-content active" id="usersTab">
        <div class="admin-card">
            <div class="card-header">
                <h2>ğŸ‘¥ ××©×ª××©×™×</h2>
                <button class="btn btn-primary btn-sm" id="addUserBtn">â• ×”×•×¡×£ ××©×ª××©</button>
            </div>
            <div class="users-list" id="usersList">
                <!-- Users will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Export Tab -->
    <div class="tab-content" id="exportTab">
        <div class="admin-card">
            <h2>ğŸ“¥ ×™×¦×•× ×“×•×—×•×ª ×œ××§×¡×œ</h2>
            <div class="export-filters">
                <div class="filter-group">
                    <label>××ª××¨×™×š</label>
                    <input type="date" id="exportDateFrom">
                </div>
                <div class="filter-group">
                    <label>×¢×“ ×ª××¨×™×š</label>
                    <input type="date" id="exportDateTo">
                </div>
                <div class="filter-group">
                    <label>×¡×•×’ ×“×•×—</label>
                    <select id="exportType">
                        <option value="">×”×›×œ</option>
                        <option value="delivery">××¡×¤×§×”</option>
                        <option value="installation">×”×ª×§× ×”</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>×¢×•×‘×“</label>
                    <select id="exportUserId">
                        <option value="">×›×œ ×”×¢×•×‘×“×™×</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary btn-lg" id="exportBtn">
                ğŸ“¥ ×”×•×¨×“ ×§×•×‘×¥ ××§×¡×œ
            </button>
        </div>
    </div>

    <!-- Reports per User Tab -->
    <div class="tab-content" id="reports-per-userTab">
        <div class="admin-card">
            <h2>ğŸ“Š ×“×•×—×•×ª ×œ×¤×™ ××©×ª××©</h2>
            <div class="user-stats-list" id="userStatsList">
                <!-- User stats will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Company / Project Tab -->
    <div class="tab-content" id="company-projectsTab">
        <div class="admin-card">
            <div class="card-header">
                <h2>ğŸ—ï¸ ×—×‘×¨×•×ª ×‘× ×™×”/×¤×¨×•×™×§×˜×™×</h2>
            </div>
            <div class="company-projects-controls">
                <input type="text" id="companyProjectName" placeholder="×”×–×Ÿ ×©× ×—×“×©...">
                <button class="btn btn-primary btn-sm" id="addCompanyProjectBtn">â• ×”×•×¡×£</button>
            </div>
            <div class="company-projects-list" id="companyProjectsList">
                <!-- List will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Inventory Tab -->
    <div class="tab-content" id="inventoryTab">
        <div class="admin-card">
            <div class="card-header">
                <h2>ğŸ“¦ ××œ××™ ××—×¡×Ÿ</h2>
                <div class="inventory-actions">
                    <button class="btn btn-secondary btn-sm" id="exportInventoryBtn">ğŸ“¥ ×™×¦×•× ××œ××™</button>
                    <button class="btn btn-primary btn-sm" id="saveInventoryBtn">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
                </div>
            </div>

            <div class="inventory-filters">
                <input type="text" id="inventorySearch" list="inventorySearchOptions" placeholder="×—×¤×© ××•×¦×¨...">
                <datalist id="inventorySearchOptions"></datalist>
            </div>

            <div class="inventory-table" id="inventoryTable">
                <!-- Inventory rows will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- User Reports Modal -->
<div class="modal" id="userReportsModal">
    <div class="modal-content modal-wide">
        <div class="modal-header">
            <h3 id="userReportsTitle">ğŸ“Š ×“×•×—×•×ª ××©×ª××©</h3>
            <button class="btn btn-ghost btn-sm" id="closeUserReports">×¡×’×•×¨</button>
        </div>
        <div class="user-reports-list" id="userReportsList"></div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal" id="addUserModal">
    <div class="modal-content">
        <h3>â• ×”×•×¡×£ ××©×ª××© ×—×“×©</h3>
        <form id="addUserForm">
            <div class="form-group">
                <label>×©× ××©×ª××©</label>
                <input type="text" id="newUsername" required>
            </div>
            <div class="form-group">
                <label>×¡×™×¡××”</label>
                <input type="password" id="newPassword" required minlength="6">
            </div>
            <div class="form-group">
                <label>×©× ××œ×</label>
                <input type="text" id="newFullName" required>
            </div>
            <div class="form-group">
                <label>×ª×¤×§×™×“</label>
                <select id="newRole">
                    <option value="user">××©×ª××© ×¨×’×™×œ</option>
                    <option value="admin">×× ×”×œ</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" id="cancelAddUser">×‘×™×˜×•×œ</button>
                <button type="submit" class="btn btn-primary">×”×•×¡×£</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Report Modal -->
<div class="modal" id="deleteReportModal">
    <div class="modal-content">
        <h3>ğŸ—‘ï¸ ××—×™×§×ª ×“×•×—</h3>
        <p>×”×× ××ª ×‘×˜×•×—×” ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×“×•×— ×”×–×”?</p>
        <p class="warning">×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!</p>
        <div class="modal-actions">
            <button class="btn btn-ghost" id="cancelDeleteReport">×‘×™×˜×•×œ</button>
            <button class="btn btn-danger" id="confirmDeleteReport">××—×§</button>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal" id="deleteUserModal">
    <div class="modal-content">
        <h3>ğŸ—‘ï¸ ××—×™×§×ª ××©×ª××©</h3>
        <p>×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××©×ª××© <strong id="deleteUserName"></strong>?</p>
        <p class="warning">×¤×¢×•×œ×” ×–×• ××™× ×” × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!</p>
        <div class="modal-actions">
            <button class="btn btn-ghost" id="cancelDeleteUser">×‘×™×˜×•×œ</button>
            <button class="btn btn-danger" id="confirmDeleteUser">××—×§</button>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal" id="editUserModal">
    <div class="modal-content">
        <h3>âœï¸ ×¢×¨×™×›×ª ××©×ª××©</h3>
        <form id="editUserForm">
            <input type="hidden" id="editUserId">
            <div class="form-group">
                <label>×©× ××œ×</label>
                <input type="text" id="editFullName" required>
            </div>
            <div class="form-group">
                <label>×ª×¤×§×™×“</label>
                <select id="editRole">
                    <option value="user">××©×ª××© ×¨×’×™×œ</option>
                    <option value="admin">×× ×”×œ</option>
                </select>
            </div>
            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" id="editIsActive" checked>
                    ××©×ª××© ×¤×¢×™×œ
                </label>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" id="cancelEditUser">×‘×™×˜×•×œ</button>
                <button type="submit" class="btn btn-primary">×©××•×¨</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let userToDelete = null;
    let usersCache = [];

    // Tab switching
    function activateTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
        if (btn) btn.classList.add('active');

        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const tab = document.getElementById(tabId + 'Tab');
        if (tab) tab.classList.add('active');
    }

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tabId = btn.dataset.tab;
            activateTab(tabId);
        });
    });

    // Load data on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadStats();
        loadUsers();
        loadCompanyProjects();
        loadInventory();

        if (window.location.hash === '#inventory') {
            activateTab('inventory');
        }
    });

    // Load statistics
    async function loadStats() {
        try {
            const response = await fetch('/api/stats');
            const data = await response.json();

            document.getElementById('totalReports').textContent = data.total_reports;
            document.getElementById('completedReports').textContent = data.completed_reports;
            document.getElementById('pendingReports').textContent = data.pending_reports;
            document.getElementById('deliveryReports').textContent = data.delivery_reports;
            document.getElementById('installationReports').textContent = data.installation_reports;

            // User stats
            renderUserStats(data.reports_per_user);
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    function renderUserStats(userStats) {
        const container = document.getElementById('userStatsList');
        container.innerHTML = userStats.map(user => `
            <button class="user-stat-item" data-user-id="${user.user_id}" data-user-name="${escapeHtml(user.full_name)}">
                <span class="user-name">${escapeHtml(user.full_name)}</span>
                <span class="user-count">${user.count} ×“×•×—×•×ª</span>
            </button>
        `).join('');

        container.querySelectorAll('.user-stat-item').forEach(btn => {
            btn.addEventListener('click', () => {
                const userId = btn.dataset.userId;
                const userName = btn.dataset.userName;
                openUserReports(userId, userName);
            });
        });
    }

    // Load users
    async function loadUsers() {
        try {
            const response = await fetch('/api/users');
            const data = await response.json();
            usersCache = data.users || [];
            renderUsers(usersCache);
            renderExportUsers(usersCache);
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    function renderUsers(users) {
        const container = document.getElementById('usersList');
        container.innerHTML = users.map(user => `
            <div class="user-item">
                <div class="user-avatar">${user.full_name[0]}</div>
                <div class="user-info">
                    <div class="user-name">${escapeHtml(user.full_name)}</div>
                    <div class="user-username">@${escapeHtml(user.username)}</div>
                </div>
                <span class="user-role ${user.role}">${user.role === 'admin' ? '×× ×”×œ' : '××©×ª××©'}</span>
                ${user.id !== {{ current_user.id }} ? `
                    <button class="btn btn-ghost btn-sm edit-user-btn" data-id="${user.id}">âœï¸</button>
                    <button class="btn btn-ghost btn-sm delete-user-btn" data-id="${user.id}" data-name="${escapeHtml(user.full_name)}">
                        ğŸ—‘ï¸
                    </button>
                ` : ''}
            </div>
        `).join('');

        // Add delete handlers
        document.querySelectorAll('.delete-user-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                userToDelete = btn.dataset.id;
                document.getElementById('deleteUserName').textContent = btn.dataset.name;
                document.getElementById('deleteUserModal').classList.add('active');
            });
        });

        // Add edit handlers
        document.querySelectorAll('.edit-user-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const userId = Number(btn.dataset.id);
                const user = usersCache.find(u => u.id === userId);
                if (!user) return;

                document.getElementById('editUserId').value = user.id;
                document.getElementById('editFullName').value = user.full_name || '';
                document.getElementById('editRole').value = user.role || 'user';
                document.getElementById('editIsActive').checked = !!user.is_active;
                document.getElementById('editUserModal').classList.add('active');
            });
        });
    }

    function renderExportUsers(users) {
        const select = document.getElementById('exportUserId');
        if (!select) return;

        select.innerHTML = '<option value="">×›×œ ×”×¢×•×‘×“×™×</option>' + users.map(u => (
            `<option value="${u.id}">${escapeHtml(u.full_name)}</option>`
        )).join('');
    }

    async function loadCompanyProjects() {
        try {
            const response = await fetch('/api/company-projects?include_inactive=false');
            const data = await response.json();
            renderCompanyProjects(data.projects || []);
        } catch (error) {
            console.error('Error loading company/projects:', error);
        }
    }

    function renderCompanyProjects(projects) {
        const container = document.getElementById('companyProjectsList');
        if (!container) return;

        if (projects.length === 0) {
            container.innerHTML = '<p class="muted">××™×Ÿ ×¨×©×™××” ×¤×¢×™×œ×” ×›×¨×’×¢</p>';
            return;
        }

        container.innerHTML = projects.map(p => `
            <div class="company-project-item">
                <span class="company-project-name">${escapeHtml(p.name)}</span>
                <button class="btn btn-ghost btn-sm delete-company-project" data-id="${p.id}">ğŸ—‘ï¸</button>
            </div>
        `).join('');

        container.querySelectorAll('.delete-company-project').forEach(btn => {
            btn.addEventListener('click', async () => {
                const id = btn.dataset.id;
                if (!id) return;

                try {
                    const response = await fetch(`/api/company-projects/${id}`, { method: 'DELETE' });
                    const data = await response.json();
                    if (data.success) {
                        showToast('× ××—×§ ×‘×”×¦×œ×—×”', 'success');
                        loadCompanyProjects();
                    } else {
                        showToast(data.error || '×©×’×™××” ×‘××—×™×§×”', 'error');
                    }
                } catch (error) {
                    showToast('×©×’×™××ª ×ª×§×©×•×¨×ª', 'error');
                }
            });
        });
    }

    document.getElementById('addCompanyProjectBtn')?.addEventListener('click', async () => {
        const input = document.getElementById('companyProjectName');
        const name = input.value.trim();
        if (!name) {
            showToast('×™×© ×œ×”×–×™×Ÿ ×©×', 'error');
            return;
        }

        try {
            const response = await fetch('/api/company-projects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });

            const data = await response.json();
            if (data.success) {
                showToast('× ×•×¡×£ ×‘×”×¦×œ×—×”', 'success');
                input.value = '';
                loadCompanyProjects();
            } else {
                showToast(data.error || '×©×’×™××” ×‘×”×•×¡×¤×”', 'error');
            }
        } catch (error) {
            showToast('×©×’×™××ª ×ª×§×©×•×¨×ª', 'error');
        }
    });

    // Inventory
    let inventoryItems = [];

    async function loadInventory() {
        try {
            const response = await fetch('/api/inventory');
            const data = await response.json();
            inventoryItems = data.items || [];
            renderInventory(inventoryItems);
            const options = document.getElementById('inventorySearchOptions');
            if (options) {
                options.innerHTML = inventoryItems.map(i => `
                    <option value="${escapeHtml(i.product_name)}"></option>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading inventory:', error);
        }
    }

    function renderInventory(items) {
        const container = document.getElementById('inventoryTable');
        if (!container) return;

        if (items.length === 0) {
            container.innerHTML = '<p class="muted">××™×Ÿ × ×ª×•× ×™ ××œ××™</p>';
            return;
        }

        container.innerHTML = items.map(item => `
            <div class="inventory-row" data-name="${escapeHtml(item.product_name)}">
                <div class="inventory-cell">
                    <label>××•×¦×¨</label>
                    <span class="inventory-name">${escapeHtml(item.product_name)}</span>
                </div>
                <div class="inventory-cell">
                    <label>×™×—×™×“×”</label>
                    <input type="number" step="0.1" class="inventory-input" data-unit="unit" value="${item.quantity_unit ?? 0}">
                </div>
                <div class="inventory-cell">
                    <label>××˜×¨</label>
                    <input type="number" step="0.1" class="inventory-input" data-unit="meter" value="${item.quantity_meter ?? 0}">
                </div>
                <div class="inventory-cell">
                    <label>×¢×•×“×›×Ÿ</label>
                    <span class="inventory-updated">${item.updated_at ? formatDate(item.updated_at) : '-'}</span>
                </div>
            </div>
        `).join('');
    }

    document.getElementById('inventorySearch')?.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        if (!term) {
            renderInventory(inventoryItems);
            return;
        }
        const filtered = inventoryItems.filter(i => i.product_name.toLowerCase().startsWith(term));
        renderInventory(filtered);
    });

    document.getElementById('saveInventoryBtn')?.addEventListener('click', async () => {
        const rows = document.querySelectorAll('.inventory-row');
        const payload = [];

        rows.forEach(row => {
            const name = row.dataset.name;
            const inputs = row.querySelectorAll('.inventory-input');
            const unitInput = Array.from(inputs).find(i => i.dataset.unit === 'unit');
            const meterInput = Array.from(inputs).find(i => i.dataset.unit === 'meter');

            payload.push({
                product_name: name,
                quantity_unit: unitInput ? unitInput.value : 0,
                quantity_meter: meterInput ? meterInput.value : 0
            });
        });

        try {
            const response = await fetch('/api/inventory/adjust', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: payload })
            });

            const data = await response.json();
            if (data.success) {
                showToast('×”××œ××™ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”', 'success');
                loadInventory();
            } else {
                showToast(data.error || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ××œ××™', 'error');
            }
        } catch (error) {
            showToast('×©×’×™××ª ×ª×§×©×•×¨×ª', 'error');
        }
    });

    document.getElementById('exportInventoryBtn')?.addEventListener('click', () => {
        window.location.href = '/api/inventory/export';
    });

    // Add user modal
    document.getElementById('addUserBtn').addEventListener('click', () => {
        document.getElementById('addUserModal').classList.add('active');
    });

    document.getElementById('cancelAddUser').addEventListener('click', () => {
        document.getElementById('addUserModal').classList.remove('active');
        document.getElementById('addUserForm').reset();
    });

    document.getElementById('addUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const userData = {
            username: document.getElementById('newUsername').value.trim(),
            password: document.getElementById('newPassword').value,
            full_name: document.getElementById('newFullName').value.trim(),
            role: document.getElementById('newRole').value
        };

        try {
            const response = await fetch('/api/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });

            const data = await response.json();

            if (data.success) {
                showToast('×”××©×ª××© × ×•×¡×£ ×‘×”×¦×œ×—×”', 'success');
                document.getElementById('addUserModal').classList.remove('active');
                document.getElementById('addUserForm').reset();
                loadUsers();
            } else {
                showToast(data.error || '×©×’×™××” ×‘×”×•×¡×¤×ª ××©×ª××©', 'error');
            }
        } catch (error) {
            showToast('×©×’×™××ª ×ª×§×©×•×¨×ª', 'error');
        }
    });

    // Delete user modal
    document.getElementById('cancelDeleteUser').addEventListener('click', () => {
        document.getElementById('deleteUserModal').classList.remove('active');
        userToDelete = null;
    });

    document.getElementById('confirmDeleteUser').addEventListener('click', async () => {
        if (!userToDelete) return;

        try {
            const response = await fetch(`/api/users/${userToDelete}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                showToast('×”××©×ª××© × ××—×§ ×‘×”×¦×œ×—×”', 'success');
                document.getElementById('deleteUserModal').classList.remove('active');
                userToDelete = null;
                loadUsers();
            } else {
                showToast(data.error || '×©×’×™××” ×‘××—×™×§×ª ××©×ª××©', 'error');
            }
        } catch (error) {
            showToast('×©×’×™××ª ×ª×§×©×•×¨×ª', 'error');
        }
    });

    // Edit user modal
    document.getElementById('cancelEditUser')?.addEventListener('click', () => {
        document.getElementById('editUserModal').classList.remove('active');
    });

    document.getElementById('editUserForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const userId = document.getElementById('editUserId').value;
        const payload = {
            full_name: document.getElementById('editFullName').value.trim(),
            role: document.getElementById('editRole').value,
            is_active: document.getElementById('editIsActive').checked
        };

        try {
            const response = await fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            if (data.success) {
                showToast('×”××©×ª××© ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”', 'success');
                document.getElementById('editUserModal').classList.remove('active');
                loadUsers();
                loadStats();
            } else {
                showToast(data.error || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ××©×ª××©', 'error');
            }
        } catch (error) {
            showToast('×©×’×™××ª ×ª×§×©×•×¨×ª', 'error');
        }
    });

    // Delete report logic
    let deleteReportId = null;
    let deleteReportUserId = null;
    let deleteReportUserName = null;

    document.getElementById('cancelDeleteReport')?.addEventListener('click', () => {
        document.getElementById('deleteReportModal').classList.remove('active');
        deleteReportId = null;
    });

    document.getElementById('deleteReportModal')?.addEventListener('click', (e) => {
        if (e.target === document.getElementById('deleteReportModal')) {
            document.getElementById('deleteReportModal').classList.remove('active');
            deleteReportId = null;
        }
    });

    document.getElementById('confirmDeleteReport')?.addEventListener('click', async () => {
        if (!deleteReportId) return;
        const btn = document.getElementById('confirmDeleteReport');
        btn.disabled = true;
        btn.textContent = '××•×—×§...';
        try {
            const response = await fetch(`/api/reports/${deleteReportId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            if (data.success) {
                showToast('×”×“×•×— × ××—×§ ×‘×”×¦×œ×—×”', 'success');
                document.getElementById('deleteReportModal').classList.remove('active');
                // Refresh the reports list
                if (deleteReportUserId && deleteReportUserName) {
                    openUserReports(deleteReportUserId, deleteReportUserName);
                }
                loadStats();
            } else {
                showToast(data.error || '×©×’×™××” ×‘××—×™×§×ª ×“×•×—', 'error');
            }
        } catch (error) {
            showToast('×©×’×™××ª ×ª×§×©×•×¨×ª', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = '××—×§';
            deleteReportId = null;
        }
    });

    // User reports modal
    document.getElementById('closeUserReports')?.addEventListener('click', () => {
        document.getElementById('userReportsModal').classList.remove('active');
    });

    async function openUserReports(userId, userName) {
        const modal = document.getElementById('userReportsModal');
        const list = document.getElementById('userReportsList');
        const title = document.getElementById('userReportsTitle');

        if (!modal || !list || !title) return;

        title.textContent = `ğŸ“Š ×“×•×—×•×ª - ${userName}`;
        list.innerHTML = '<div class="inventory-empty">×˜×•×¢×Ÿ ×“×•×—×•×ª...</div>';
        modal.classList.add('active');

        try {
            const response = await fetch(`/api/reports?user_id=${userId}&per_page=200`);
            const data = await response.json();
            const reports = data.reports || [];

            if (reports.length === 0) {
                list.innerHTML = '<div class="inventory-empty">××™×Ÿ ×“×•×—×•×ª ×œ××©×ª××© ×–×”</div>';
                return;
            }

            list.innerHTML = reports.map(r => `
                <div class="user-report-row">
                    <a class="user-report-item" href="/report/${r.id}">
                        <span class="report-title">${r.report_type === 'delivery' ? '××¡×¤×§×”' : '×”×ª×§× ×”'} â€¢ ${escapeHtml(r.address || '')}</span>
                        <span class="report-meta">${formatDate(r.timestamp)} â€¢ ${r.status === 'completed' ? '×”×•×©×œ×' : '× ×“×¨×© ×—×–×¨×”'}</span>
                    </a>
                    <button class="btn btn-ghost btn-sm btn-delete-report" data-report-id="${r.id}" title="××—×§ ×“×•×—">ğŸ—‘ï¸</button>
                </div>
            `).join('');

            // Attach delete report handlers
            list.querySelectorAll('.btn-delete-report').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    deleteReportId = btn.dataset.reportId;
                    deleteReportUserId = userId;
                    deleteReportUserName = userName;
                    document.getElementById('deleteReportModal').classList.add('active');
                });
            });
        } catch (error) {
            list.innerHTML = '<div class="inventory-empty">×©×’×™××ª ×˜×¢×™× ×”</div>';
        }
    }

    // Export
    document.getElementById('exportBtn').addEventListener('click', () => {
        const params = new URLSearchParams();

        const dateFrom = document.getElementById('exportDateFrom').value;
        const dateTo = document.getElementById('exportDateTo').value;
        const type = document.getElementById('exportType').value;
        const userId = document.getElementById('exportUserId')?.value;

        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        if (type) params.append('type', type);
        if (userId) params.append('user_id', userId);

        window.location.href = `/api/export?${params}`;
    });

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        if (Number.isNaN(date.getTime())) return '-';
        return date.toLocaleString('he-IL');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
